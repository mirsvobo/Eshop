<!DOCTYPE html>
<html lang="cs" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>
    <title th:text="${product.name}">Detail produktu</title>
    <th:block th:if="${jsonLdDataString != null}">
        <script type="application/ld+json" th:utext="${jsonLdDataString}"></script>
    </th:block>
    <th:block layout:fragment="css">
        <link rel="stylesheet" type="text/css" th:href="@{/css/custom.css}"/>
    </th:block>
</head>

<body>

<section layout:fragment="content">
    <div class="container product-detail-container">

        <div class="row">
            <div class="col-md-6 product-images-column">
                <img th:src="${product.getImagesOrdered().isEmpty() ? '/images/placeholder.png' : product.getImagesOrdered().get(0).url}"
                     th:alt="${product.getImagesOrdered().isEmpty() ? product.name : (product.getImagesOrdered().get(0).altText ?: product.name)}"
                     class="main-product-image img-fluid" id="mainProductImage">

                <div class="thumbnail-images" th:if="${product.getImagesOrdered().size() > 1}">
                    <img th:each="img, iterStat : ${product.getImagesOrdered()}"
                         th:src="@{${img.url}}"
                         th:alt="${img.altText ?: 'Náhled ' + (iterStat.index + 1)}"
                         th:classappend="${iterStat.index == 0} ? 'active'"
                         th:onclick="'changeMainImage(\'' + ${img.url} + '\', this)'"
                         class="img-thumbnail">
                </div>
            </div>

            <div class="col-md-6 product-info-column">
                <h1 class="product-title" th:text="${product.name}">Název Produktu</h1>

                <div class="product-price-section mb-3" th:with="pInfo=${priceInfo}">
                    <div th:if="${pInfo != null and pInfo.discountedPrice != null and pInfo.originalPrice != null}">
                        <small class="original-price"
                               th:text="${#numbers.formatDecimal(pInfo.originalPrice, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currentGlobalCurrency}">
                        </small>
                    </div>
                    <div class="d-flex align-items-baseline">
                        <span class="price h2" id="productPrice">
                            <span th:if="${pInfo != null and (pInfo.discountedPrice != null or pInfo.originalPrice != null)}"
                                  th:text="${#numbers.formatDecimal(pInfo.discountedPrice ?: pInfo.originalPrice, 1, 'WHITESPACE', 2, 'COMMA')}">
                                Cena
                            </span>
                            <span th:unless="${pInfo != null and (pInfo.discountedPrice != null or pInfo.originalPrice != null)}">
                                Cena nezadána
                            </span>
                        </span>
                        <span class="ms-1" th:text="' ' + ${currentGlobalCurrency == 'EUR' ? '€' : 'Kč'}"></span>
                        <span th:if="${pInfo != null and pInfo.discountApplied != null}"
                              class="badge bg-danger discount-badge ms-2"
                              th:title="${pInfo.discountApplied.name}">
                            SLEVA
                        </span>
                    </div>
                    <p class="price-note mb-0">Cena bez DPH.</p>
                </div>

                <div class="product-short-description" th:if="${product.shortDescription}" th:text="${product.shortDescription}">
                    Krátký popis produktu zde...
                </div>

                <form th:action="@{/kosik/pridat}" method="post" class="product-options-form" id="add-to-cart-form">
                    <input type="hidden" name="productId" th:value="${product.id}" />
                    <input type="hidden" name="isCustom" value="false" />

                    <div class="mb-3" th:if="${!product.availableDesigns.isEmpty()}">
                        <label for="design" class="form-label">Design:</label>
                        <select id="design" name="selectedDesignId" class="form-select" required>
                            <option value="" selected disabled>Vyberte design</option>
                            <option th:each="design : ${product.availableDesigns}"
                                    th:value="${design.id}"
                                    th:text="${design.name} + (${design.priceSurchargeCZK > 0 || design.priceSurchargeEUR > 0} ? ' (' + (${currentGlobalCurrency == 'EUR' ? '+ ' + #numbers.formatDecimal(design.priceSurchargeEUR, 0, 'COMMA', 2, 'POINT') + ' €' : '+ ' + #numbers.formatDecimal(design.priceSurchargeCZK, 0, 'COMMA', 2, 'POINT') + ' Kč'}) + ')' : '')"
                                    th:data-surcharge-czk="${design.priceSurchargeCZK}"
                                    th:data-surcharge-eur="${design.priceSurchargeEUR}">
                                Název designu
                            </option>
                        </select>
                    </div>

                    <div class="mb-3" th:if="${!product.availableGlazes.isEmpty()}">
                        <label for="glaze" class="form-label">Lazura:</label>
                        <select id="glaze" name="selectedGlazeId" class="form-select" required>
                            <option value="" selected disabled>Vyberte lazuru</option>
                            <option th:each="glaze : ${product.availableGlazes}"
                                    th:value="${glaze.id}"
                                    th:text="${glaze.name} + (${glaze.priceSurchargeCZK > 0 || glaze.priceSurchargeEUR > 0} ? ' (' + (${currentGlobalCurrency == 'EUR' ? '+ ' + #numbers.formatDecimal(glaze.priceSurchargeEUR, 0, 'COMMA', 2, 'POINT') + ' €' : '+ ' + #numbers.formatDecimal(glaze.priceSurchargeCZK, 0, 'COMMA', 2, 'POINT') + ' Kč'}) + ')' : '')"
                                    th:data-surcharge-czk="${glaze.priceSurchargeCZK}"
                                    th:data-surcharge-eur="${glaze.priceSurchargeEUR}">
                                Název lazury
                            </option>
                        </select>
                    </div>

                    <div class="mb-3" th:if="${!product.availableRoofColors.isEmpty()}">
                        <label for="roofColor" class="form-label">Barva střechy:</label>
                        <select id="roofColor" name="selectedRoofColorId" class="form-select" required>
                            <option value="" selected disabled>Vyberte barvu střechy</option>
                            <option th:each="roofColor : ${product.availableRoofColors}"
                                    th:value="${roofColor.id}"
                                    th:text="${roofColor.name} + (${roofColor.priceSurchargeCZK > 0 || roofColor.priceSurchargeEUR > 0} ? ' (' + (${currentGlobalCurrency == 'EUR' ? '+ ' + #numbers.formatDecimal(roofColor.priceSurchargeEUR, 0, 'COMMA', 2, 'POINT') + ' €' : '+ ' + #numbers.formatDecimal(roofColor.priceSurchargeCZK, 0, 'COMMA', 2, 'POINT') + ' Kč'}) + ')' : '')"
                                    th:data-surcharge-czk="${roofColor.priceSurchargeCZK}"
                                    th:data-surcharge-eur="${roofColor.priceSurchargeEUR}">
                                Název barvy střechy
                            </option>
                        </select>
                    </div>

                    <div class="mb-3 tax-selection" th:if="${product.availableTaxRates != null and !product.availableTaxRates.isEmpty()}">
                        <label class="form-label d-block">Režim DPH: <i class="bi bi-info-circle tax-info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Více informací o sazbách DPH"></i> </label>
                        <div class="form-check" th:each="taxRate, iterStat : ${product.availableTaxRates}">
                            <input class="form-check-input" type="radio" name="selectedTaxRateId" th:id="'taxRate' + ${taxRate.id}" th:value="${taxRate.id}" th:checked="${iterStat.index == 0}" required>
                            <label class="form-check-label" th:for="'taxRate' + ${taxRate.id}">
                                <span th:text="${taxRate.name}">Název sazby</span>
                                <span th:if="${taxRate.note != null and not #strings.isEmpty(taxRate.note)}"
                                      th:text="' - ' + ${taxRate.note}"
                                      class="text-muted small"> - Poznámka</span>
                            </label>
                            <div class="tax-info-details" th:if="${taxRate.rate == 0.12}">Snížená sazba 12 % platí dle §48 zákona o DPH pouze pro fyzické osoby (neplátce DPH) pro stavby pro sociální bydlení (rodinné domy do 350 m², byty do 120 m² podlahové plochy). <strong>Vyžaduje podpis Čestného prohlášení.</strong></div>
                            <div class="tax-info-details" th:if="${taxRate.rate == 0.21}">Základní sazba 21 % platí pro firmy (právnické osoby, OSVČ plátce DPH) a pro fyzické osoby, pokud se jedná o stavbu pro rekreaci nebo nejsou splněny podmínky pro sníženou sazbu.</div>
                            <div class="tax-info-details" th:if="${taxRate.reverseCharge}">Režim přenesené daňové povinnosti platí při poskytnutí stavebních a montážních prací plátci DPH. Daň přiznává odběratel.</div>
                        </div>
                    </div>
                    <div class="alert alert-warning" th:if="${product.availableTaxRates == null or product.availableTaxRates.isEmpty()}">
                        Pro tento produkt nejsou definovány sazby DPH. Prosím kontaktujte nás.
                    </div>

                    <div class="mb-3">
                        <label for="quantity" class="form-label">Množství:</label>
                        <input type="number" id="quantity" name="quantity" class="form-control quantity-input" value="1" min="1" required>
                    </div>

                    <button type="submit" class="btn btn-success add-to-cart-btn w-100"
                            th:disabled="${product.availableTaxRates == null or product.availableTaxRates.isEmpty()}">
                        <i class="bi bi-cart-plus"></i> Přidat do košíku
                    </button>
                </form>
            </div>
        </div>

        <div class="row">
            <div class="col-12 product-long-description">
                <hr class="my-4">
                <h3>Podrobný popis produktu</h3>
                <div th:utext="${product.description}">
                    Zde bude hlavní popis produktu z backendu...
                </div>

                <div class="variation-gallery mt-4">
                    <div th:if="${availableDesigns != null and !availableDesigns.isEmpty()}" class="mb-4">
                        <h4>Dostupné designy</h4>
                        <div th:each="design : ${availableDesigns}" class="d-inline-block text-center me-2 mb-2">
                            <img th:src="${design.imageUrl} ?: '/images/placeholder.png'"
                                 th:alt="${design.name}" th:title="${design.name}" class="img-thumbnail" style="width: 200px; height: 200px; object-fit: cover;">
                            <p class="small mb-0" th:text="${design.name}" style="max-width: 200px; overflow-wrap: break-word;">Název Designu</p> </div>
                    </div>

                    <div th:if="${availableGlazes != null and !availableGlazes.isEmpty()}" class="mb-4">
                        <h4>Dostupné lazury</h4>
                        <div th:each="glaze : ${availableGlazes}" class="d-inline-block text-center me-2 mb-2">
                            <img th:src="${glaze.imageUrl} ?: '/images/placeholder.png'"
                                 th:alt="${glaze.name}" th:title="${glaze.name}" class="img-thumbnail" style="width: 200px; height: 200px; object-fit: cover;">
                            <p class="small mb-0" th:text="${glaze.name}" style="max-width: 200px; overflow-wrap: break-word;">Název Lazury</p>
                        </div>
                    </div>

                    <div th:if="${availableRoofColors != null and !availableRoofColors.isEmpty()}" class="mb-4">
                        <h4>Barvy střešní krytiny</h4>
                        <div th:each="roofColor : ${availableRoofColors}" class="d-inline-block text-center me-2 mb-2">
                            <img th:src="${roofColor.imageUrl} ?: '/images/placeholder.png'"
                                 th:alt="${roofColor.name}" th:title="${roofColor.name}" class="img-thumbnail" style="width: 200px; height: 200px; object-fit: cover;">
                            <p class="small mb-0" th:text="${roofColor.name}" style="max-width: 200px; overflow-wrap: break-word;">Název Barvy</p>
                        </div>
                    </div>
                </div> </div> </div> <div class="row">
        <div class="col-12">
            <section class="advantages-section">
                <h3>Proč dřevník od nás?</h3>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <ul>
                            <li><i class="bi bi-gem"></i> Nešetříme na kvalitních materiálech.</li>
                            <li><i class="bi bi-tools"></i> Dřevník sestrojíme a umístíme zdarma.</li>
                            <li><i class="bi bi-pencil-square"></i> Dřevník upravíme na míru (barva, rozměry, doplňky).</li>
                            <li><i class="bi bi-shield-check"></i> 20+ let zkušeností a poctivé řemeslo.</li>
                            <li><i class="bi bi-calendar-check"></i> Dodání standardně do 5 týdnů.</li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>
    </div>

    </div> </section> <th:block layout:fragment="javascript" th:with="td=${trackingData != null ? trackingData : new java.util.HashMap()}">

    <script>
        // Funkce pro změnu hlavního obrázku
        function changeMainImage(newImageUrl, thumbnailElement) {
            const mainImg = document.getElementById('mainProductImage');
            if (mainImg) mainImg.src = newImageUrl;
            document.querySelectorAll('.thumbnail-images img').forEach(img => img.classList.remove('active'));
            if (thumbnailElement) thumbnailElement.classList.add('active');
        }

        // Inicializace tooltipů (pro ikonu informací o DPH)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const productDataForTracking = {
            id: /*[[${td.productId}]]*/ null,
            name: /*[[${td.productName}]]*/ null,
            priceNoVat: /*[[${td.priceForTrackingNoVat}]]*/ 0.0,
            priceWithVat: /*[[${td.priceForTrackingWithVat}]]*/ 0.0, // Pro Google Ads
            currency: /*[[${td.currency}]]*/ 'CZK',
            category: /*[[${td.categoryName}]]*/ 'Dřevníky',
            brand: /*[[${td.brandName}]]*/ 'Dřevníky Kolář',
            variantId: /*[[${td.variantId}]]*/ null
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Ready: Attempting to track view_item for product:", productDataForTracking.variantId);
            if (typeof TrackingService !== 'undefined' && typeof TrackingService.trackViewItem === 'function') {
                TrackingService.trackViewItem(productDataForTracking);
            } else {
                console.error("TrackingService or trackViewItem function not available when trying to track view_item.");
                // Můžeš zde přidat fallback nebo počkat, např. pomocí setTimeout a opakované kontroly
                // setTimeout(() => {
                //     if (typeof TrackingService !== 'undefined' && typeof TrackingService.trackViewItem === 'function') {
                //        TrackingService.trackViewItem(productDataForTracking);
                //     } else { console.error("TrackingService still not ready after delay."); }
                // }, 500);
            }
        });

        // Tato funkce je pro custom produkt, ale definice zde nevadí
        function updateTrackingPrices(newPriceNoVat, newPriceWithVat) {
            if(productDataForTracking) {
                console.log('Updating tracked prices in productDataForTracking:', newPriceNoVat, newPriceWithVat);
                productDataForTracking.priceNoVat = newPriceNoVat;
                productDataForTracking.priceWithVat = newPriceWithVat;
            } else {
                console.warn("productDataForTracking not defined when updateTrackingPrices was called.");
            }
        }
        /*]]>*/
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const addToCartForm = document.getElementById(/*[[${product.customisable ? 'custom-product-form' : 'add-to-cart-form'}]]*/ 'add-to-cart-form');
        const quantityInput = document.getElementById('quantity');

        if (addToCartForm && quantityInput) {
            addToCartForm.addEventListener('submit', function(event) {
                const quantity = parseInt(quantityInput.value) || 1;
                const priceNoVat = parseFloat(/*[[${td.priceForTrackingNoVat}]]*/ 0.0);
                const currency = /*[[${td.currency}]]*/ 'CZK';
                const variantId = /*[[${td.variantId}]]*/ null;
                const productName = /*[[${td.productName}]]*/ null;
                const categoryName = /*[[${td.categoryName}]]*/ 'Dřevníky';
                const brandName = /*[[${td.brandName}]]*/ 'Dřevníky Kolář';

                if (!variantId) {
                    console.warn("trackAddToCart: variantId not found in tracking data. Skipping.");
                    return;
                }

                const itemDataForTracking = {
                    variantId: variantId,
                    name: productName,
                    price: priceNoVat,
                    currency: currency,
                    quantity: quantity,
                    category: categoryName,
                    brand: brandName
                };

                console.log("Add to Cart form submitted. Attempting to track:", itemDataForTracking);

                if (typeof TrackingService !== 'undefined' && typeof TrackingService.trackAddToCart === 'function') {
                    TrackingService.trackAddToCart(itemDataForTracking);
                } else {
                    console.error("TrackingService or trackAddToCart function not available when trying to track add_to_cart.");
                }
            });
            console.log("Event listener for trackAddToCart attached to form:", addToCartForm.id);
        } else {
            if (!addToCartForm) console.error("Add to Cart form not found for tracking.");
            if (!quantityInput) console.error("Quantity input not found for tracking add to cart.");
        }
        /*]]>*/
    </script>

</th:block>
</body>
</html>