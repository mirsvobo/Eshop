<!DOCTYPE html>
<html lang="cs" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>
    <title th:text="${product.name} + ' | Dřevníky Kolář'">Detail produktu</title>

    <th:block layout:fragment="css">
        <style>
            /* Základní styly pro produktovou stránku (Standard) */
            .product-detail-container {
                padding-top: 2rem;
                padding-bottom: 2rem;
            }
            /* Obrázky */
            .main-product-image { max-width: 100%; height: auto; border: 1px solid #dee2e6; margin-bottom: 1rem; }
            .thumbnail-images img { width: 80px; height: 80px; object-fit: cover; cursor: pointer; border: 1px solid #dee2e6; margin-right: 0.5rem; margin-bottom: 0.5rem; opacity: 0.7; transition: opacity 0.2s ease-in-out; }
            .thumbnail-images img.active, .thumbnail-images img:hover { opacity: 1; border-color: #007bff; }

            /* === ZAČÁTEK NOVÝCH/UPRAVENÝCH STYLŮ PRO CENU === */
            .product-price-section {
                margin-bottom: 1rem; /* Odsazení pod celou sekcí ceny */
            }
            /* Přeškrtnutá původní cena */
            .original-price {
                font-size: 1rem; /* Větší než předtím */
                color: #6c757d;
                text-decoration: line-through;
                display: block; /* Zajistí, že je na samostatném řádku */
                margin-bottom: -0.2em; /* Mírné přiblížení k finální ceně */
                line-height: 1;
            }
            /* Finální cena */
            .product-price-section .price {
                font-size: 2rem; /* Větší hlavní cena (třída h2 přidána v HTML) */
                font-weight: 700; /* Tučnější */
                color: var(--bs-primary); /* Hlavní zelená */
                line-height: 1.1;
                margin-right: 0.2rem; /* Malá mezera od měny */
            }
            /* Měna vedle finální ceny */
            .product-price-section .ms-1 { /* Cílíme na span s měnou */
                font-size: 1.1rem; /* Menší než hlavní cena */
                font-weight: 600;
                color: #495057; /* Tmavší šedá */
                padding-left: 0.2rem;
            }
            /* Odznak slevy */
            .discount-badge {
                font-size: 0.7em;
                vertical-align: baseline; /* Lepší zarovnání s textem ceny */
                padding: 0.3em 0.5em;
                font-weight: bold;
                /* ms-2 třída v HTML zajistí odsazení zleva */
            }
            /* Poznámka pod cenou */
            .product-price-section .price-note {
                font-size: 0.85rem; /* Menší text */
                color: #6c757d;
                margin-top: 0.1rem; /* Malá mezera nad poznámkou */
                margin-bottom: 0;
                display: block; /* Na samostatném řádku */
            }
            /* === KONEC NOVÝCH/UPRAVENÝCH STYLŮ PRO CENU === */

            .product-short-description { margin-top: 1rem; margin-bottom: 1.5rem; color: #495057; }
            /* Formulář variant */
            .product-options-form .form-label { font-weight: bold; }
            .product-options-form .form-select, .product-options-form .form-control { margin-bottom: 1rem; }
            /* Informace o DPH */
            .tax-selection .form-check { margin-bottom: 0.5rem; }
            .tax-info-icon { cursor: pointer; color: #007bff; margin-left: 5px; }
            .tax-info-details { font-size: 0.85rem; color: #6c757d; margin-left: 1.5rem; margin-bottom: 1rem; display: none; border-left: 3px solid #007bff; padding-left: 10px; }
            .tax-selection .form-check:has(input:checked) + .tax-info-details { display: block; }
            /* Množství a tlačítko košíku */
            .quantity-input { width: 80px; }
            .add-to-cart-btn { padding: 0.75rem 1.5rem; font-size: 1.1rem; }
            /* Klíčové informace */
            .key-info-banner { background-color: #e9f5ff; border-left: 5px solid #007bff; padding: 1rem; margin-top: 1.5rem; margin-bottom: 1.5rem; }
            .key-info-banner p { margin-bottom: 0.5rem; font-weight: 500; }
            .key-info-banner i { margin-right: 0.5rem; color: #007bff; }
            /* Popis a galerie variant */
            .product-long-description { margin-top: 2rem; clear: both; }
            .product-long-description h3 { margin-top: 1.5rem; margin-bottom: 1rem; }
            .variation-gallery { margin-top: 1rem; margin-bottom: 2rem; }
            .variation-gallery h4 { font-size: 1.1rem; margin-bottom: 0.8rem; }
            .variation-gallery img { width: 100px; height: 100px; object-fit: cover; margin-right: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #dee2e6; cursor: pointer; }
            .variation-gallery img:hover { border-color: #007bff; }
            /* Sekce výhod */
            .advantages-section { background-color: #f8f9fa; padding: 2rem 1rem; margin-top: 2rem; border-radius: 5px; }
            .advantages-section h3 { text-align: center; margin-bottom: 1.5rem; }
            .advantages-section ul { list-style: none; padding-left: 0; }
            .advantages-section li { display: flex; align-items: center; margin-bottom: 1rem; font-size: 1.1rem; }
            .advantages-section i { color: #28a745; font-size: 1.5rem; margin-right: 1rem; width: 30px; text-align: center; }
            /* Responzivita pro desktop */
            @media (min-width: 768px) {
                .product-images-column { position: sticky; top: 80px; /* Upraveno kvůli fixed-top navbaru */ max-height: calc(100vh - 100px); overflow-y: auto; padding-right: 1rem; }
                .product-info-column { padding-left: 1rem; }
                .product-long-description { margin-top: 0; }
                .advantages-section { padding: 2rem; }
            }
            /* Úprava odsazení kvůli fixed-top navbaru */
            body { padding-top: 70px; /* Výška navbaru + malé odsazení */ }
        </style>
    </th:block>
</head>

<body>

<section layout:fragment="content">
    <div class="container product-detail-container">

        <div class="row">
            <div class="col-md-6 product-images-column">
                <img th:src="@{${product.getImagesOrdered().isEmpty() ? '/images/placeholder.png' : product.getImagesOrdered().get(0).url}}"
                     th:alt="${product.getImagesOrdered().isEmpty() ? product.name : (product.getImagesOrdered().get(0).altText ?: product.name)}"
                     class="main-product-image img-fluid" id="mainProductImage">

                <div class="thumbnail-images" th:if="${product.getImagesOrdered().size() > 1}">
                    <img th:each="img, iterStat : ${product.getImagesOrdered()}"
                         th:src="@{${img.url}}"
                         th:alt="${img.altText ?: 'Náhled ' + (iterStat.index + 1)}"
                         th:classappend="${iterStat.index == 0} ? 'active'"
                         th:onclick="'changeMainImage(\'' + @{${img.url}} + '\', this)'"
                         class="img-thumbnail">
                </div>
            </div>

            <div class="col-md-6 product-info-column">
                <h1 class="product-title" th:text="${product.name}">Název Produktu</h1>

                <div class="product-price-section mb-3" th:with="pInfo=${priceInfo}">
                    <div th:if="${pInfo != null and pInfo.discountedPrice != null and pInfo.originalPrice != null}">
                        <small class="original-price"
                               th:text="${#numbers.formatDecimal(pInfo.originalPrice, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currentGlobalCurrency}">
                        </small>
                    </div>

                    <div class="d-flex align-items-baseline">
                        <span class="price h2" id="productPrice"> <span th:if="${pInfo != null and (pInfo.discountedPrice != null or pInfo.originalPrice != null)}"
                                                                        th:text="${#numbers.formatDecimal(pInfo.discountedPrice ?: pInfo.originalPrice, 1, 'WHITESPACE', 2, 'COMMA')}">
                                Cena
                            </span>
                            <span th:unless="${pInfo != null and (pInfo.discountedPrice != null or pInfo.originalPrice != null)}">
                                Cena nezadána
                            </span>
                        </span>
                        <span class="ms-1" th:text="' ' + ${currentGlobalCurrency == 'EUR' ? '€' : 'Kč'}"></span>
                        <span th:if="${pInfo != null and pInfo.discountApplied != null}"
                              class="badge bg-danger discount-badge ms-2"
                              th:title="${pInfo.discountApplied.name}">
                            SLEVA
                        </span>
                    </div>

                    <p class="price-note mb-0">Cena bez DPH.</p>
                </div>
                <div class="product-short-description" th:if="${product.shortDescription}" th:text="${product.shortDescription}">
                    Krátký popis produktu zde...
                </div>
                <form th:action="@{/kosik/pridat}" method="post" class="product-options-form" id="add-to-cart-form">
                    <input type="hidden" name="productId" th:value="${product.id}" />
                    <input type="hidden" name="isCustom" value="false" />

                    <div class="mb-3" th:if="${!product.availableDesigns.isEmpty()}">
                        <label for="design" class="form-label">Design:</label>
                        <select id="design" name="selectedDesignId" class="form-select" required>
                            <option value="" selected disabled>Vyberte design</option>
                            <option th:each="design : ${product.availableDesigns}"
                                    th:value="${design.id}"
                                    th:text="${design.name} + (${design.priceSurchargeCZK > 0 || design.priceSurchargeEUR > 0} ? ' (' + (${currentGlobalCurrency == 'EUR' ? '+ ' + #numbers.formatDecimal(design.priceSurchargeEUR, 0, 'COMMA', 2, 'POINT') + ' €' : '+ ' + #numbers.formatDecimal(design.priceSurchargeCZK, 0, 'COMMA', 2, 'POINT') + ' Kč'}) + ')' : '')"
                                    th:data-surcharge-czk="${design.priceSurchargeCZK}"
                                    th:data-surcharge-eur="${design.priceSurchargeEUR}">
                                Název designu
                            </option>
                        </select>
                    </div>

                    <div class="mb-3" th:if="${!product.availableGlazes.isEmpty()}">
                        <label for="glaze" class="form-label">Lazura:</label>
                        <select id="glaze" name="selectedGlazeId" class="form-select" required>
                            <option value="" selected disabled>Vyberte lazuru</option>
                            <option th:each="glaze : ${product.availableGlazes}"
                                    th:value="${glaze.id}"
                                    th:text="${glaze.name} + (${glaze.priceSurchargeCZK > 0 || glaze.priceSurchargeEUR > 0} ? ' (' + (${currentGlobalCurrency == 'EUR' ? '+ ' + #numbers.formatDecimal(glaze.priceSurchargeEUR, 0, 'COMMA', 2, 'POINT') + ' €' : '+ ' + #numbers.formatDecimal(glaze.priceSurchargeCZK, 0, 'COMMA', 2, 'POINT') + ' Kč'}) + ')' : '')"
                                    th:data-surcharge-czk="${glaze.priceSurchargeCZK}"
                                    th:data-surcharge-eur="${glaze.priceSurchargeEUR}">
                                Název lazury
                            </option>
                        </select>
                    </div>

                    <div class="mb-3" th:if="${!product.availableRoofColors.isEmpty()}">
                        <label for="roofColor" class="form-label">Barva střechy:</label>
                        <select id="roofColor" name="selectedRoofColorId" class="form-select" required>
                            <option value="" selected disabled>Vyberte barvu střechy</option>
                            <option th:each="roofColor : ${product.availableRoofColors}"
                                    th:value="${roofColor.id}"
                                    th:text="${roofColor.name} + (${roofColor.priceSurchargeCZK > 0 || roofColor.priceSurchargeEUR > 0} ? ' (' + (${currentGlobalCurrency == 'EUR' ? '+ ' + #numbers.formatDecimal(roofColor.priceSurchargeEUR, 0, 'COMMA', 2, 'POINT') + ' €' : '+ ' + #numbers.formatDecimal(roofColor.priceSurchargeCZK, 0, 'COMMA', 2, 'POINT') + ' Kč'}) + ')' : '')"
                                    th:data-surcharge-czk="${roofColor.priceSurchargeCZK}"
                                    th:data-surcharge-eur="${roofColor.priceSurchargeEUR}">
                                Název barvy střechy
                            </option>
                        </select>
                    </div>

                    <div class="mb-3 tax-selection" th:if="${product.availableTaxRates != null and !product.availableTaxRates.isEmpty()}">
                        <label class="form-label d-block">Režim DPH: <i class="bi bi-info-circle tax-info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Více informací o sazbách DPH"></i> </label>
                        <div class="form-check" th:each="taxRate, iterStat : ${product.availableTaxRates}">
                            <input class="form-check-input" type="radio" name="selectedTaxRateId" th:id="'taxRate' + ${taxRate.id}" th:value="${taxRate.id}" th:checked="${iterStat.index == 0}" required>
                            <label class="form-check-label" th:for="'taxRate' + ${taxRate.id}">
                                <span th:text="${taxRate.name}">Název sazby</span>
                                <span th:if="${taxRate.note != null and not #strings.isEmpty(taxRate.note)}"
                                      th:text="' - ' + ${taxRate.note}"
                                      class="text-muted small"> - Poznámka</span>
                            </label>
                            <div class="tax-info-details" th:if="${taxRate.rate == 0.12}">
                                Snížená sazba 12 % platí dle §48 zákona o DPH pouze pro fyzické osoby (neplátce DPH) pro stavby pro sociální bydlení (rodinné domy do 350 m², byty do 120 m² podlahové plochy). <strong>Vyžaduje podpis Čestného prohlášení.</strong>
                            </div>
                            <div class="tax-info-details" th:if="${taxRate.rate == 0.21}">
                                Základní sazba 21 % platí pro firmy (právnické osoby, OSVČ plátce DPH) a pro fyzické osoby, pokud se jedná o stavbu pro rekreaci nebo nejsou splněny podmínky pro sníženou sazbu.
                            </div>
                            <div class="tax-info-details" th:if="${taxRate.reverseCharge}">
                                Režim přenesené daňové povinnosti platí při poskytnutí stavebních a montážních prací plátci DPH. Daň přiznává odběratel.
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-warning" th:if="${product.availableTaxRates == null or product.availableTaxRates.isEmpty()}">
                        Pro tento produkt nejsou definovány sazby DPH. Prosím kontaktujte nás.
                    </div>

                    <div class="mb-3">
                        <label for="quantity" class="form-label">Množství:</label>
                        <input type="number" id="quantity" name="quantity" class="form-control quantity-input" value="1" min="1" required>
                    </div>

                    <button type="submit" class="btn btn-success add-to-cart-btn w-100"
                            th:disabled="${product.availableTaxRates == null or product.availableTaxRates.isEmpty()}">
                        <i class="bi bi-cart-plus"></i> Přidat do košíku
                    </button>
                </form>
            </div>
        </div>

        <div class="row">
            <div class="col-12 product-long-description">
                <hr class="my-4">
                <h3>Podrobný popis produktu</h3>
                <div th:utext="${product.description}">
                    Zde bude hlavní popis produktu z backendu...
                </div>

                <div class="variation-gallery mt-4">
                    <div th:if="${!product.availableDesigns.isEmpty()}" class="mb-4">
                        <h4>Možné designy</h4>
                        <img th:each="design : ${product.availableDesigns}"
                             th:src="@{${design.imageUrl} ?: '/images/placeholder.png'}"
                             th:alt="${design.name}" th:title="${design.name}" class="img-thumbnail">
                    </div>
                    <div th:if="${!product.availableGlazes.isEmpty()}" class="mb-4">
                        <h4>Dostupné lazury</h4>
                        <img th:each="glaze : ${product.availableGlazes}"
                             th:src="@{${glaze.imageUrl} ?: '/images/placeholder.png'}"
                             th:alt="${glaze.name}" th:title="${glaze.name}" class="img-thumbnail">
                    </div>
                    <div th:if="${!product.availableRoofColors.isEmpty()}" class="mb-4">
                        <h4>Dostupné barvy střech</h4>
                        <img th:each="roofColor : ${product.availableRoofColors}"
                             th:src="@{${roofColor.imageUrl} ?: '/images/placeholder.png'}"
                             th:alt="${roofColor.name}" th:title="${roofColor.name}" class="img-thumbnail">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <section class="advantages-section">
                    <h3>Proč dřevník od nás?</h3>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <ul>
                                <li><i class="bi bi-gem"></i> Nešetříme na kvalitních materiálech.</li>
                                <li><i class="bi bi-tools"></i> Dřevník sestrojíme a umístíme zdarma.</li>
                                <li><i class="bi bi-pencil-square"></i> Dřevník upravíme na míru (barva, rozměry, doplňky).</li>
                                <li><i class="bi bi-shield-check"></i> 20+ let zkušeností a poctivé řemeslo.</li>
                                <li><i class="bi bi-calendar-check"></i> Dodání standardně do 5 týdnů.</li>
                            </ul>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <script type="application/ld+json" th:inline="javascript">
            /*<![CDATA[*/
            {
                "@context": "https://schema.org/",
                "@type": "Product",
                "name": /*[[${product.name}]]*/ "Název Dřevníku",
                "description": /*[[${product.shortDescription ?: #strings.abbreviate(product.description, 250)}]]*/ "Popis dřevníku...",
                "image": [
                    /*[# th:each="img, iterStat : ${product.getImagesOrdered()}"]*/
                    /*[[${#request.scheme + '://' + #request.serverName + #request.contextPath + img.url}]]*/
                    /*[# th:if="${!iterStat.last}"]*/, /*[/]*/
                    /*[/]*/
                ],
                "sku": /*[[${product.slug}]]*/ "SKU123",
                "brand": { "@type": "Brand", "name": "Dřevníky Kolář" },
                "offers": {
                    "@type": "Offer",
                    "url": /*[[${#request.requestURL}]]*/ "URL produktu",
                    "price": /*[[${(priceInfo != null ? (priceInfo.discountedPrice ?: priceInfo.originalPrice) : (currentGlobalCurrency == 'EUR' ? product.basePriceEUR : product.basePriceCZK)) ?: '0.00'}]]*/ "15000.00",
                    "priceCurrency": /*[[${currentGlobalCurrency}]]*/ "CZK",
                    "availability": "https://schema.org/InStock",
                    "priceValidUntil": /*[[${#dates.format(#dates.createNow().plusDays(90), 'yyyy-MM-dd')}]]*/ "2025-12-31",
                    "itemCondition": "https://schema.org/NewCondition"
                },
                "additionalProperty": [
                    {"@type": "PropertyValue", "name": "Materiál", "value": /*[[${product.material} ?: 'Smrkové dřevo']]*/ "Smrkové dřevo"},
                    {"@type": "PropertyValue", "name": "Montáž zdarma", "value": "Ano"},
                    {"@type": "PropertyValue", "name": "Dodání do", "value": "5 týdnů"}
                ]
            }
            /*]]>*/
        </script>

    </div>
</section>

<th:block layout:fragment="javascript">
    <script>
        // Funkce pro změnu hlavního obrázku (beze změny)
        function changeMainImage(newImageUrl, thumbnailElement) {
            const mainImg = document.getElementById('mainProductImage');
            if (mainImg) mainImg.src = newImageUrl;
            document.querySelectorAll('.thumbnail-images img').forEach(img => img.classList.remove('active'));
            if (thumbnailElement) thumbnailElement.classList.add('active');
        }

        // Funkce pro update ceny (nyní už není potřeba, cena se nemění dynamicky)
        // function updateDisplayedPrice() { ... }

        // Odstranění listenerů pro update ceny
        // document.querySelectorAll('#add-to-cart-form select').forEach(select => {
        //    select.removeEventListener('change', updateDisplayedPrice);
        // });

        // Inicializace tooltipů (zůstává)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

    </script>
</th:block>

</body>
</html>