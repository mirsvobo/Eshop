<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${product.name}">Produkt na míru</title>
    <meta name="description" th:content="${product.metaDescription != null ? product.metaDescription : #strings.abbreviate(product.description, 160)}" layout:fragment="meta-description"/>

    <th:block layout:fragment="css">
        <style>
            .product-images img.main-image { max-width: 100%; height: auto; display: block; margin-bottom: 15px; border: 1px solid #dee2e6; cursor: pointer; background-color: #fff; padding: 0.25rem; border-radius: 0.375rem; }
            .product-thumbnails { display: flex; gap: 8px; flex-wrap: wrap; }
            .product-thumbnails img { width: 80px; height: 80px; object-fit: cover; border: 2px solid #dee2e6; cursor: pointer; opacity: 0.7; border-radius: 0.25rem; transition: opacity 0.2s ease-in-out, border-color 0.2s ease-in-out; }
            .product-thumbnails img:hover { opacity: 1.0; }
            .product-thumbnails img.active { border-color: var(--bs-primary); opacity: 1.0; }
            .price { font-size: 1.8em; font-weight: bold; color: var(--bs-danger); margin-bottom: 15px; min-height: 1.2em; /* Min výška pro stabilitu layoutu */ }
            .price-eur { font-size: 0.8em; color: #6c757d; }
            .configurator-section, .addons-section { border: 1px solid #e0e0e0; padding: 1.5rem; margin-top: 1.5rem; background-color: #f8f9fa; border-radius: 0.375rem; margin-bottom: 1.5rem; }
            .range-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
            .range-container label { min-width: 80px; }
            .range-container .form-range { flex: 1 1 auto; min-width: 150px; }
            .range-container .range-value { display: inline-block; width: 55px; text-align: right; vertical-align: middle; font-family: monospace; font-weight: bold; }
            .range-container small { flex-basis: 100%; margin-left: 90px; font-size: 0.8em; }
            .error { color: var(--bs-danger); font-size: 0.875em; display: block; margin-top: 0.25rem; }
            .form-check-label.checkbox-label { margin-left: 0.3rem; font-weight: normal; }
        </style>
    </th:block>

    <script type="application/ld+json" th:inline="javascript">
        //<![CDATA[
        {
            "@context": "https://schema.org/",
            "@type": "Product",
            "name": /*[[${product.name}]]*/ "Produkt na míru",
            "description": /*[[${product.metaDescription != null ? product.metaDescription : #strings.abbreviate(product.description, 250)}]]*/ "Popis produktu...",
            "sku": /*[[ 'CUSTOM-' + ${product.id} ]]*/ "SKU-CUSTOM-XYZ",
            "image": /*[[${product.images != null && !#lists.isEmpty(product.images) ? product.images[0].url : null}]]*/ "/images/placeholder.png",
            "brand": { "@type": "Brand", "name": "Dřevníky Kolář" },
            "offers": {
                "@type": "Offer",
                "priceCurrency": "CZK",
                "price": /*[[${initialCustomPriceCZK != null ? initialCustomPriceCZK : '0.00'}]]*/ "0.00", // Výchozí cena
                "additionalProperty": [
                    {"@type": "PropertyValue", "name": "Price CZK", "value": /*[[${initialCustomPriceCZK}]]*/ null },
                    {"@type": "PropertyValue", "name": "Price EUR", "value": /*[[${initialCustomPriceEUR}]]*/ null }
                ],
                "url": /*[[@{/produkt/{slug}(slug=${product.slug})}]]*/ "/produkt/slug",
                "availability": /*[[${product.active ? 'https://schema.org/InStock' : 'https://schema.org/OutOfStock'}]]*/ "https://schema.org/InStock",
                "itemCondition": "https://schema.org/NewCondition",
                "seller": { "@type": "Organization", "name": "Dřevníky Kolář" }
            }
        }
        //]]>
    </script>
</head>
<body>

<section layout:fragment="content">
    <div class="container mt-5">
        <div th:if="${cartSuccess}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${cartSuccess}"></span> <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${cartError}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${cartError}"></span> <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${configuratorError}" class="alert alert-warning" role="alert" th:text="${configuratorError}">
            Chyba konfigurace.
        </div>

        <div class="row" th:unless="${configuratorError}" th:object="${product}">
            <div class="col-lg-6 product-images mb-4 mb-lg-0">
                <img th:if="*{images != null and not #lists.isEmpty(images)}"
                     th:src="*{images[0].url}"
                     th:alt="*{images[0].altText != null ? images[0].altText : name}"
                     id="mainProductImage" class="main-image img-fluid shadow-sm" />
                <img th:unless="*{images != null and not #lists.isEmpty(images)}"
                     th:src="@{/images/placeholder.png}" alt="Produkt bez obrázku" class="main-image img-fluid shadow-sm"/>

                <div class="product-thumbnails mt-3" th:if="*{images != null and #lists.size(images) > 1}">
                    <img th:each="img, iter : *{images}"
                         th:src="${img.url}"
                         th:alt="${img.altText != null ? img.altText : name + ' - náhled ' + (iter.index + 1)}"
                         th:classappend="${iter.index == 0} ? 'active'"
                         th:data-img-url="${img.url}"
                         onclick="changeMainImage(this)"/>
                </div>
            </div>

            <div class="col-lg-6 product-info">
                <h1 class="mb-3" th:text="*{name}">Produkt na míru</h1>

                <div class="price mb-2" id="product-price-display">
                    <span th:if="${initialCustomPriceError}" class="text-danger" th:text="${initialCustomPriceError}"></span>
                    <span th:unless="${initialCustomPriceError}">Cena se načítá...</span>
                </div>
                <div id="customPriceErrorDisplay" class="error mb-3" style="display: none;"></div>

                <div th:utext="*{description}" class="mb-4">Popis produktu...</div>
                <hr class="mb-4"/>

                <form th:action="@{/kosik/pridat}" method="post" id="add-to-cart-form" th:object="${cartItemDto}">
                    <input type="hidden" th:field="*{productId}" />
                    <input type="hidden" th:field="*{custom}" value="true" />

                    <div class="configurator-section" th:if="${configurator != null}">
                        <h3 class="h5 mb-3">Navrhněte si vlastní rozměry a vzhled</h3>

                        <div class="mb-3 range-container">
                            <label for="customLength" class="form-label">Délka:</label>
                            <input type="range" class="form-range" id="customLength" th:field="*{customDimensions['length']}"
                                   th:min="${configurator.minLength}" th:max="${configurator.maxLength}" step="1"
                                   th:value="${configurator.minLength}" oninput="updateRangeValue('customLength', 'customLengthValue'); handleCustomConfigChange();"/>
                            <span class="range-value" id="customLengthValue" th:text="${configurator.minLength.stripTrailingZeros().toPlainString()}"></span> cm
                            <small th:text="'[' + ${configurator.minLength.stripTrailingZeros().toPlainString()} + '-' + ${configurator.maxLength.stripTrailingZeros().toPlainString()} + ']'" class="text-muted"></small>
                        </div>
                        <div class="mb-3 range-container">
                            <label for="customWidth" class="form-label">Hloubka:</label>
                            <input type="range" class="form-range" id="customWidth" th:field="*{customDimensions['width']}"
                                   th:min="${configurator.minWidth}" th:max="${configurator.maxWidth}" step="1"
                                   th:value="${configurator.minWidth}" oninput="updateRangeValue('customWidth', 'customWidthValue'); handleCustomConfigChange();"/>
                            <span class="range-value" id="customWidthValue" th:text="${configurator.minWidth.stripTrailingZeros().toPlainString()}"></span> cm
                            <small th:text="'[' + ${configurator.minWidth.stripTrailingZeros().toPlainString()} + '-' + ${configurator.maxWidth.stripTrailingZeros().toPlainString()} + ']'" class="text-muted"></small>
                        </div>
                        <div class="mb-3 range-container">
                            <label for="customHeight" class="form-label">Výška:</label>
                            <input type="range" class="form-range" id="customHeight" th:field="*{customDimensions['height']}"
                                   th:min="${configurator.minHeight}" th:max="${configurator.maxHeight}" step="1"
                                   th:value="${configurator.minHeight}" oninput="updateRangeValue('customHeight', 'customHeightValue'); handleCustomConfigChange();"/>
                            <span class="range-value" id="customHeightValue" th:text="${configurator.minHeight.stripTrailingZeros().toPlainString()}"></span> cm
                            <small th:text="'[' + ${configurator.minHeight.stripTrailingZeros().toPlainString()} + '-' + ${configurator.maxHeight.stripTrailingZeros().toPlainString()} + ']'" class="text-muted"></small>
                        </div>

                        <hr>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="customGlaze" class="form-label">Lazura:</label>
                                <input type="text" class="form-control form-control-sm" id="customGlaze" th:field="*{customGlaze}" placeholder="Např. Ořech" oninput="handleCustomConfigChange()"/>
                            </div>
                            <div class="col-md-6">
                                <label for="customRoofColor" class="form-label">Barva střechy:</label>
                                <input type="text" class="form-control form-control-sm" id="customRoofColor" th:field="*{customRoofColor}" placeholder="Např. Antracit" oninput="handleCustomConfigChange()"/>
                            </div>
                            <div class="col-md-6">
                                <label for="customRoofOverstep" class="form-label">Přesah střechy:</label>
                                <input type="text" class="form-control form-control-sm" id="customRoofOverstep" th:field="*{customRoofOverstep}" placeholder="Např. Standardní" oninput="handleCustomConfigChange()"/>
                            </div>
                            <div class="col-md-6">
                                <label for="customDesign" class="form-label">Design:</label>
                                <input type="text" class="form-control form-control-sm" id="customDesign" th:field="*{customDesign}" placeholder="Např. Klasik" oninput="handleCustomConfigChange()"/>
                            </div>
                        </div>

                        <hr>
                        <h6 class="mt-3 mb-2">Volitelné prvky:</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="customHasDivider" th:field="*{customHasDivider}" value="true" onchange="handleCustomConfigChange()"/>
                            <label class="form-check-label checkbox-label" for="customHasDivider">Příčka</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="customHasGutter" th:field="*{customHasGutter}" value="true" onchange="handleCustomConfigChange()"/>
                            <label class="form-check-label checkbox-label" for="customHasGutter">Okap</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="customHasGardenShed" th:field="*{customHasGardenShed}" value="true" onchange="handleCustomConfigChange()"/>
                            <label class="form-check-label checkbox-label" for="customHasGardenShed">Zahradní domek</label>
                        </div>

                        <div th:if="${initialCustomPriceError}" class="error mt-3" th:text="${initialCustomPriceError}"></div>

                    </div> <div class="addons-section mt-4" th:if="${availableAddons != null and not #lists.isEmpty(availableAddons)}">
                    <h3 class="h5 mb-3">Volitelné doplňky:</h3>
                    <div th:each="addon, iter : ${availableAddons}" th:if="${addon.active}" class="form-check mb-2">
                        <input class="form-check-input" type="checkbox"
                               th:id="'addon_' + ${addon.id}"
                               th:name="'selectedAddons[' + ${iter.index} + '].addonId'"
                               th:value="${addon.id}" onchange="handleFixedAddonChange()" />
                        <label class="form-check-label checkbox-label" th:for="'addon_' + ${addon.id}"
                               th:text="${addon.name} + ' (' + ${#numbers.formatDecimal(addon.priceCZK, 1, 'DEFAULT', 2, 'DEFAULT')} + ' Kč / ' + ${#numbers.formatDecimal(addon.priceEUR, 1, 'DEFAULT', 2, 'DEFAULT')} + ' EUR)'">
                        </label>
                        <input type="hidden" th:name="'selectedAddons[' + ${iter.index} + '].quantity'" value="1" />
                        <input type="hidden" th:id="'addon_price_czk_' + ${addon.id}" th:value="${addon.priceCZK}">
                        <input type="hidden" th:id="'addon_price_eur_' + ${addon.id}" th:value="${addon.priceEUR}">
                    </div>
                </div> <div class="row mt-4 align-items-center">
                    <div class="col-auto">
                        <label for="quantity" class="form-label">Množství:</label>
                    </div>
                    <div class="col-auto">
                        <input type="number" class="form-control" style="width: 80px;" id="quantity" th:field="*{quantity}" value="1" min="1" max="99" required onchange="updateDisplayPrice()"/>
                    </div>
                    <div class="col">
                        <button type="submit" class="btn btn-success btn-lg w-100" th:disabled="${initialCustomPriceError != null or configuratorError != null}">
                            <i class="bi bi-cart-plus-fill me-2"></i> Přidat do košíku
                        </button>
                    </div>
                </div>
                </form> </div> </div> <div class="row mt-5" th:unless="${configuratorError}" th:object="${product}">
        <div class="col">
            <h2>Základní parametry</h2>
            <p>Rozměry, vzhled a další parametry si volíte sami v konfigurátoru výše.</p>
            <table class="table table-striped table-sm">
                <tbody>
                <tr th:if="${product.material}"><th>Základní materiál</th><td th:text="${product.material}"></td></tr>
                <tr th:if="${product.taxRate}"><th>Sazba DPH</th><td th:text="${#numbers.formatDecimal(product.taxRate.rate * 100, 1, 'DEFAULT', 0, 'DEFAULT')} + '%'"></td></tr>
                <tr th:if="${product.taxRate != null and product.taxRate.reverseCharge}"><th>Režim DPH</th><td>Přenesená daňová povinnost</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    </div> </section>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        //<![CDATA[
        // JS pro dynamickou kalkulaci

        // --- Bezpečné předání dat z controlleru ---
        // Pouze ID produktu v mapě
        const productJsData = /*[[${productJsData}]]*/ null;
        // Prázdná mapa, JS nepotřebuje přímo data konfigurátoru (min/max bere z HTML)
        const configJsData = /*[[${configJsData}]]*/ null;
        // Ceny jsou čísla (BigDecimal se převede na číslo nebo null)
        const initialCustomPriceCZK = /*[[${initialCustomPriceCZK}]]*/ null;
        const initialCustomPriceEUR = /*[[${initialCustomPriceEUR}]]*/ null;
        // CSRF tokeny jsou stringy
        const csrfToken = /*[[${_csrf?.token}]]*/ null;
        const csrfHeader = /*[[${_csrf?.headerName}]]*/ null;
        // Chyba z controlleru je string
        const initialErrorFromServer = /*[[${initialCustomPriceError}]]*/ null;

        // --- Globální proměnné pro JS ---
        let currentUnitPriceCZK = parseFloat(initialCustomPriceCZK) || 0;
        let currentUnitPriceEUR = parseFloat(initialCustomPriceEUR) || 0;
        let calculationTimeout;
        const DEBOUNCE_DELAY = 300; // ms

        // --- Funkce pro UI ---
        function changeMainImage(thumbElement) {
            if (!thumbElement) return;
            const imageUrl = thumbElement.getAttribute('data-img-url');
            if (imageUrl) {
                const mainImage = document.getElementById('mainProductImage');
                if(mainImage) mainImage.src = imageUrl;
            }
            document.querySelectorAll('.product-thumbnails img').forEach(img => img.classList.remove('active'));
            thumbElement.classList.add('active');
        }

        function updateRangeValue(rangeId, valueId) {
            const rangeInput = document.getElementById(rangeId);
            const valueSpan = document.getElementById(valueId);
            if (rangeInput && valueSpan) { valueSpan.textContent = rangeInput.value; }
        }

        function formatCurrency(amount, currencyCode) {
            if (amount == null || isNaN(amount)) return "---";
            const locale = currencyCode === 'EUR' ? 'sk-SK' : 'cs-CZ';
            try {
                // Použít maximumFractionDigits pro zajištění dvou desetinných míst
                return Number(amount).toLocaleString(locale, { style: 'currency', currency: currencyCode, minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } catch (e) {
                console.error("Error formatting currency:", amount, currencyCode, e);
                // Fallback - zaokrouhlit na 2 místa
                return (Math.round(amount * 100) / 100).toFixed(2) + " " + currencyCode;
            }
        }

        function getSelectedFixedAddonsPrice(currency) {
            let totalAddonPrice = 0;
            const addonCheckboxes = document.querySelectorAll('.addons-section input[type="checkbox"]:checked');
            addonCheckboxes.forEach(checkbox => {
                const addonId = checkbox.value;
                const priceInputId = currency === 'EUR' ? 'addon_price_eur_' + addonId : 'addon_price_czk_' + addonId;
                const priceInput = document.getElementById(priceInputId);
                if (priceInput && priceInput.value) {
                    const price = parseFloat(priceInput.value);
                    if (!isNaN(price)) { totalAddonPrice += price; }
                    else { console.warn(`Invalid price value found for addon ${addonId} in currency ${currency}: ${priceInput.value}`); }
                } else { console.warn(`Price input not found for addon ${addonId} in currency ${currency}`); }
            });
            return Math.round(totalAddonPrice * 100) / 100;
        }

        function updateDisplayPrice() {
            const quantityInput = document.getElementById('quantity');
            const quantity = quantityInput ? (parseInt(quantityInput.value) || 1) : 1;
            const addonsPriceCZK = getSelectedFixedAddonsPrice('CZK');
            const addonsPriceEUR = getSelectedFixedAddonsPrice('EUR');
            const unitCZK = isNaN(currentUnitPriceCZK) ? 0 : currentUnitPriceCZK;
            const unitEUR = isNaN(currentUnitPriceEUR) ? 0 : currentUnitPriceEUR;
            const totalCZK = quantity * (unitCZK + addonsPriceCZK);
            const totalEUR = quantity * (unitEUR + addonsPriceEUR);
            const priceDisplay = document.getElementById('product-price-display');
            const errorDiv = document.getElementById('customPriceErrorDisplay');

            if (isNaN(totalCZK) || isNaN(totalEUR)) {
                if(priceDisplay) priceDisplay.innerHTML = '<span class="text-danger">Chyba výpočtu</span>';
                if(errorDiv && errorDiv.style.display === 'none') {
                    errorDiv.textContent = 'Při výpočtu ceny došlo k chybě.'; errorDiv.style.display = 'block';
                }
            } else {
                if (priceDisplay) {
                    let czkHtml = formatCurrency(totalCZK, 'CZK');
                    let eurHtml = formatCurrency(totalEUR, 'EUR');
                    priceDisplay.innerHTML = `${czkHtml} <span class="price-eur">/ ${eurHtml}</span>`;
                    priceDisplay.style.display = 'block';
                }
                if(errorDiv) errorDiv.style.display = 'none';
            }
        }

        function displayCalculationError(message) {
            const priceDisplay = document.getElementById('product-price-display');
            const errorDiv = document.getElementById('customPriceErrorDisplay');
            if(priceDisplay) priceDisplay.innerHTML = `<span class="text-danger">Chyba</span>`;
            if (errorDiv) {
                errorDiv.textContent = message || 'Při výpočtu ceny došlo k chybě.'; // Zobrazit specifickou nebo obecnou chybu
                errorDiv.style.display = 'block';
            }
            updateDisplayPrice(); // Zkusí přepočítat s (nyní nulovou) základní cenou a doplňky
        }

        // --- Kalkulace ceny (volá /api/product/calculate-price) ---
        function handleCustomConfigChange() {
            clearTimeout(calculationTimeout);
            calculationTimeout = setTimeout(() => {
                calculatePriceApiCall();
            }, DEBOUNCE_DELAY);
        }

        function calculatePriceApiCall() {
            if (!productJsData || !productJsData.id) {
                console.warn("Missing productJsData.id for calculation.");
                displayCalculationError('Chyba konfigurace stránky (ID produktu).');
                return;
            }
            if (!document.getElementById('customLength')) { // Jen základní kontrola existence elementu
                console.warn("Configurator HTML elements not found.");
                displayCalculationError('Chyba konfigurace stránky (elementy).');
                return;
            }

            const requestPayload = {
                productId: productJsData.id,
                customDimensions: {
                    length: document.getElementById('customLength')?.value || '0',
                    width: document.getElementById('customWidth')?.value || '0',
                    height: document.getElementById('customHeight')?.value || '0'
                },
                customGlaze: document.getElementById('customGlaze')?.value,
                customRoofColor: document.getElementById('customRoofColor')?.value,
                customRoofOverstep: document.getElementById('customRoofOverstep')?.value,
                customDesign: document.getElementById('customDesign')?.value,
                customHasDivider: document.getElementById('customHasDivider')?.checked || false,
                customHasGutter: document.getElementById('customHasGutter')?.checked || false,
                customHasGardenShed: document.getElementById('customHasGardenShed')?.checked || false
            };
            console.log("Calculating custom price with payload:", JSON.stringify(requestPayload));

            const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
            if (csrfHeader && csrfToken) { headers[csrfHeader] = csrfToken; }

            const priceDisplay = document.getElementById('product-price-display');
            if(priceDisplay) priceDisplay.innerHTML = 'Počítám cenu...';
            const errorDiv = document.getElementById('customPriceErrorDisplay');
            if(errorDiv) { errorDiv.textContent = ''; errorDiv.style.display = 'none'; }

            fetch('/api/product/calculate-price', { method: 'POST', headers: headers, body: JSON.stringify(requestPayload) })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw { status: response.status, message: err.errorMessage || err.message || `Chyba ${response.status}` };
                        }).catch(() => {
                            throw { status: response.status, message: `Chyba serveru (${response.status})` };
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received custom unit prices:", data);
                    if (data.errorMessage) {
                        throw { message: data.errorMessage };
                    }
                    currentUnitPriceCZK = parseFloat(data.priceCZK) || 0;
                    currentUnitPriceEUR = parseFloat(data.priceEUR) || 0;
                    updateDisplayPrice();
                })
                .catch(error => {
                    console.error('Error calculating custom price:', error);
                    currentUnitPriceCZK = 0; currentUnitPriceEUR = 0;
                    displayCalculationError(error.message); // Zobrazit chybu z API nebo obecnou
                });
        }

        // Přepočet ceny při změně fixních doplňků
        function handleFixedAddonChange() { updateDisplayPrice(); }

        // --- Inicializace ---
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializace posuvníků
            ['customLength', 'customWidth', 'customHeight'].forEach(id => {
                const inputElement = document.getElementById(id);
                if (inputElement) {
                    updateRangeValue(id, id + 'Value');
                    inputElement.addEventListener('input', handleCustomConfigChange);
                }
            });

            // Nastavení počáteční ceny / Spuštění prvního výpočtu
            if (document.getElementById('product-price-display')) {
                if (initialErrorFromServer) {
                    displayCalculationError(initialErrorFromServer);
                } else if (initialCustomPriceCZK !== null || initialCustomPriceEUR !== null) {
                    updateDisplayPrice(); // Zobrazí předpočítanou + doplňky
                } else if (productJsData && productJsData.id && document.getElementById('customLength')) { // Máme ID a elementy?
                    calculatePriceApiCall(); // Zkusit vypočítat, pokud nebyla chyba
                } else {
                    displayCalculationError('Chyba konfigurace produktu nebo dat.');
                }
            }

            // Ostatní listenery
            const textInputs = document.querySelectorAll('.configurator-section input[type="text"]');
            textInputs.forEach(input => {if(input) input.addEventListener('input', handleCustomConfigChange)});
            const checkInputs = document.querySelectorAll('.configurator-section input[type="checkbox"]');
            checkInputs.forEach(input => {if(input) input.addEventListener('change', handleCustomConfigChange)});
            const quantityInput = document.getElementById('quantity');
            if (quantityInput) {
                quantityInput.addEventListener('change', updateDisplayPrice);
                quantityInput.addEventListener('input', updateDisplayPrice);
            }
            const addonCheckboxes = document.querySelectorAll('.addons-section input[type="checkbox"]');
            addonCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', handleFixedAddonChange);
            });

        }); // End DOMContentLoaded

        //]]>
    </script>
</th:block>

</body>
</html>