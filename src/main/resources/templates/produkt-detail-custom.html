<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${product?.name ?: 'Produkt na míru'}">Produkt na míru</title>
    <meta name="description" th:content="${product?.metaDescription != null ? product.metaDescription : (#strings.isEmpty(product?.shortDescription) ? #strings.abbreviate(product.description, 160) : product.shortDescription)}" layout:fragment="meta-description"/>

    <th:block layout:fragment="css">
        <style>
            /* Existing styles ... */
            .product-images img.main-image { max-width: 100%; height: auto; display: block; margin-bottom: 15px; border: 1px solid #dee2e6; cursor: pointer; background-color: #fff; padding: 0.25rem; border-radius: 0.375rem; }
            .product-thumbnails { display: flex; gap: 8px; flex-wrap: wrap; }
            .product-thumbnails img { width: 80px; height: 80px; object-fit: cover; border: 2px solid #dee2e6; cursor: pointer; opacity: 0.7; border-radius: 0.25rem; transition: opacity 0.2s ease-in-out, border-color 0.2s ease-in-out; }
            .product-thumbnails img:hover { opacity: 1.0; }
            .product-thumbnails img.active { border-color: var(--bs-primary); opacity: 1.0; }
            .price { font-size: 1.8em; font-weight: bold; color: var(--bs-danger); margin-bottom: 15px; min-height: 1.2em; transition: opacity 0.2s ease-in-out; }
            .price.calculating { opacity: 0.6; }
            .price-eur { font-size: 0.8em; color: #6c757d; }
            .configurator-section, .addons-section { border: 1px solid #e0e0e0; padding: 1.5rem; margin-top: 1.5rem; background-color: #f8f9fa; border-radius: 0.375rem; margin-bottom: 1.5rem; }
            .range-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 0.5rem; }
            .range-container label { min-width: 100px; }
            .range-container .form-range { flex: 1 1 auto; min-width: 150px; }
            .range-container .range-value { display: inline-block; width: 65px; text-align: right; vertical-align: middle; font-family: monospace; font-weight: bold; background-color:#e9ecef; padding: .1rem .3rem; border-radius: .25rem; font-size: 0.9em;}
            .range-container small { flex-basis: 100%; margin-left: 110px; font-size: 0.8em; color: #6c757d; margin-top: -0.3rem; }
            .error { color: var(--bs-danger); font-size: 0.875em; display: block; margin-top: 0.25rem; }
            .form-check-label.checkbox-label { margin-left: 0.3rem; font-weight: normal; }
            .price .spinner-border-sm { vertical-align: middle; margin-left: 5px; }
            .attribute-select-error, .addon-select-error { /* Shared style for select errors */
                color: var(--bs-danger); font-size: 0.875em; display: block; margin-top: 0.25rem;
            }
            .addon-category-group { margin-bottom: 1rem; } /* Spacing between addon groups */
            .addon-category-group label { font-weight: bold; }
        </style>
    </th:block>

</head>
<body>

<section layout:fragment="content">
    <div class="container mt-5 mb-5">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}">Domů</a></li>
                <li class="breadcrumb-item"><a th:href="@{/produkty}">Produkty</a></li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${product?.name ?: 'Produkt na míru'}">Produkt na míru</li>
            </ol>
        </nav>

        <div th:if="${cartSuccess}" class="alert alert-success alert-dismissible fade show" role="alert">...</div>
        <div th:if="${cartError}" class="alert alert-danger alert-dismissible fade show" role="alert">...</div>
        <div th:if="${configuratorError != null}" class="alert alert-warning" role="alert" th:text="${configuratorError}">Chyba konfigurátoru.</div>
        <div th:if="${productError}" class="alert alert-warning" role="alert" th:text="${productError}">Produkt nelze objednat.</div>

        <div class="row g-4" th:if="${product != null and configuratorError == null and productError == null}" th:object="${product}">
            <div class="col-lg-6 product-images mb-4 mb-lg-0">
                <img th:if="*{images != null and not #lists.isEmpty(getImagesOrdered())}"
                     th:src="*{getImagesOrdered()[0].url}"
                     th:alt="*{getImagesOrdered()[0].altText ?: name}"
                     id="mainProductImageCustom" class="main-image img-fluid shadow-sm" />
                <img th:unless="*{images != null and not #lists.isEmpty(getImagesOrdered())}"
                     th:src="@{/images/placeholder-custom.png}" alt="Produkt na míru - Ilustrační obrázek" class="main-image img-fluid shadow-sm"/>
                <div class="product-thumbnails mt-3" th:if="*{images != null and #lists.size(images) > 1}">
                    <img th:each="img, iter : *{getImagesOrdered()}"
                         th:src="${img.url}"
                         th:alt="|*{name} - náhled ${iter.index + 1}|"
                         th:class="${iter.index == 0} ? 'active' : ''"
                         th:onclick="|document.getElementById('mainProductImageCustom').src='${img.url}'; document.querySelectorAll('.product-thumbnails img').forEach(el => el.classList.remove('active')); this.classList.add('active');|"
                    />
                </div>
            </div>

            <div class="col-lg-6 product-info">
                <h1 class="mb-3" th:text="*{name}">Produkt na míru</h1>

                <div class="price mb-2" id="product-price-display">
                    <span class="spinner-border spinner-border-sm text-primary d-none" id="price-spinner" role="status" aria-hidden="true"></span>
                    <span id="price-value">Načítání ceny...</span>
                    <span class="text-muted ms-1">(bez DPH)</span>
                </div>
                <div id="customPriceErrorDisplay" class="error mb-3" style="display: none;"></div>
                <div th:if="${product.shortDescription != null}" class="lead text-muted mb-3" th:text="*{shortDescription}">Krátký popis produktu.</div>
                <div th:utext="*{description}" class="mb-4 description-content"> Hlavní popis produktu na míru... </div>
                <hr class="mb-4"/>

                <form th:action="@{/kosik/pridat}" method="post" id="add-to-cart-form" th:object="${cartItemDto}"
                      th:data-product-id="${product.id}"
                      th:data-initial-czk="${initialCustomPriceCZK}"
                      th:data-initial-eur="${initialCustomPriceEUR}"
                      th:data-initial-error="${initialCustomPriceError}"
                      th:data-calculate-url="@{/api/product/calculate-price}"
                      th:data-currency-symbol="${currentGlobalCurrency == 'EUR' ? '€' : 'Kč'}">

                    <input type="hidden" th:field="*{productId}" />
                    <input type="hidden" th:field="*{custom}" value="true" />
                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

                    <div class="configurator-section" th:if="${configurator != null}">
                        <h3 class="h5 mb-3">Navrhněte si vlastní rozměry a vzhled</h3>

                        <div class="mb-3 range-container">
                            <label for="customLength" class="form-label">Šířka (délka):</label>
                            <input type="range" class="form-range dimension-slider config-input" id="customLength" name="customDimensions[length]"
                                   th:min="${configurator.minLength ?: 100}" th:max="${configurator.maxLength ?: 500}" th:step="${configurator.stepLength ?: 10}"
                                   th:value="*{customDimensions['length'] ?: configurator.defaultLength ?: configurator.minLength}" />
                            <span class="range-value"><span id="customLengthValueDisplay">...</span> cm</span>
                            <small th:if="${configurator.minLength != null and configurator.maxLength != null}"
                                   th:text="'[' + ${#numbers.formatDecimal(configurator.minLength, 1, 'POINT', 0, 'POINT')} + ' - ' + ${#numbers.formatDecimal(configurator.maxLength, 1, 'POINT', 0, 'POINT')} + ' cm]'"
                                   class="text-muted"></small>
                        </div>
                        <div class="mb-3 range-container">
                            <label for="customWidth" class="form-label">Hloubka (šířka):</label>
                            <input type="range" class="form-range dimension-slider config-input" id="customWidth" name="customDimensions[width]"
                                   th:min="${configurator.minWidth ?: 50}" th:max="${configurator.maxWidth ?: 200}" th:step="${configurator.stepWidth ?: 10}"
                                   th:value="*{customDimensions['width'] ?: configurator.defaultWidth ?: configurator.minWidth}" />
                            <span class="range-value"><span id="customWidthValueDisplay">...</span> cm</span>
                            <small th:if="${configurator.minWidth != null and configurator.maxWidth != null}"
                                   th:text="'[' + ${#numbers.formatDecimal(configurator.minWidth, 1, 'POINT', 0, 'POINT')} + ' - ' + ${#numbers.formatDecimal(configurator.maxWidth, 1, 'POINT', 0, 'POINT')} + ' cm]'"
                                   class="text-muted"></small>
                        </div>
                        <div class="mb-3 range-container">
                            <label for="customHeight" class="form-label">Výška:</label>
                            <input type="range" class="form-range dimension-slider config-input" id="customHeight" name="customDimensions[height]"
                                   th:min="${configurator.minHeight ?: 150}" th:max="${configurator.maxHeight ?: 300}" th:step="${configurator.stepHeight ?: 5}"
                                   th:value="*{customDimensions['height'] ?: configurator.defaultHeight ?: configurator.minHeight}" />
                            <span class="range-value"><span id="customHeightValueDisplay">...</span> cm</span>
                            <small th:if="${configurator.minHeight != null and configurator.maxHeight != null}"
                                   th:text="'[' + ${#numbers.formatDecimal(configurator.minHeight, 1, 'POINT', 0, 'POINT')} + ' - ' + ${#numbers.formatDecimal(configurator.maxHeight, 1, 'POINT', 0, 'POINT')} + ' cm]'"
                                   class="text-muted"></small>
                        </div>

                        <hr>
                        <div class="row g-3">
                            <div class="col-md-6 mb-3">
                                <label for="designSelect" class="form-label fw-bold">Design:</label>
                                <select class="form-select config-input attribute-select" id="designSelect" th:field="*{selectedDesignId}" required>
                                    <option value="" disabled selected>-- Vyberte design --</option>
                                    <option th:each="designOpt : ${availableDesigns}"
                                            th:value="${designOpt.id}"
                                            th:with="priceCzk=${designOpt.priceSurchargeCZK ?: T(java.math.BigDecimal).ZERO}, priceEur=${designOpt.priceSurchargeEUR ?: T(java.math.BigDecimal).ZERO}, priceToShow=${currentGlobalCurrency == 'EUR' ? priceEur : priceCzk}"
                                            th:text="|${designOpt.name} ${ priceToShow.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? '(+ ' + #numbers.formatDecimal(priceToShow, 1, 'POINT', 2, 'COMMA') + ' ' + (currentGlobalCurrency == 'EUR' ? '€' : 'Kč') + ')' : '' }|"
                                            th:data-price-czk="${priceCzk}"
                                            th:data-price-eur="${priceEur}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('selectedDesignId')}" class="attribute-select-error">Vyberte prosím design.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="glazeSelect" class="form-label fw-bold">Lazura:</label>
                                <select class="form-select config-input attribute-select" id="glazeSelect" th:field="*{selectedGlazeId}" required>
                                    <option value="" disabled selected>-- Vyberte lazuru --</option>
                                    <option th:each="glazeOpt : ${availableGlazes}"
                                            th:value="${glazeOpt.id}"
                                            th:with="priceCzk=${glazeOpt.priceSurchargeCZK ?: T(java.math.BigDecimal).ZERO}, priceEur=${glazeOpt.priceSurchargeEUR ?: T(java.math.BigDecimal).ZERO}, priceToShow=${currentGlobalCurrency == 'EUR' ? priceEur : priceCzk}"
                                            th:text="|${glazeOpt.name} ${ priceToShow.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? '(+ ' + #numbers.formatDecimal(priceToShow, 1, 'POINT', 2, 'COMMA') + ' ' + (currentGlobalCurrency == 'EUR' ? '€' : 'Kč') + ')' : '' }|"
                                            th:data-price-czk="${priceCzk}"
                                            th:data-price-eur="${priceEur}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('selectedGlazeId')}" class="attribute-select-error">Vyberte prosím lazuru.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="roofColorSelect" class="form-label fw-bold">Barva střechy:</label>
                                <select class="form-select config-input attribute-select" id="roofColorSelect" th:field="*{selectedRoofColorId}" required>
                                    <option value="" disabled selected>-- Vyberte barvu --</option>
                                    <option th:each="colorOpt : ${availableRoofColors}"
                                            th:value="${colorOpt.id}"
                                            th:with="priceCzk=${colorOpt.priceSurchargeCZK ?: T(java.math.BigDecimal).ZERO}, priceEur=${colorOpt.priceSurchargeEUR ?: T(java.math.BigDecimal).ZERO}, priceToShow=${currentGlobalCurrency == 'EUR' ? priceEur : priceCzk}"
                                            th:text="|${colorOpt.name} ${ priceToShow.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? '(+ ' + #numbers.formatDecimal(priceToShow, 1, 'POINT', 2, 'COMMA') + ' ' + (currentGlobalCurrency == 'EUR' ? '€' : 'Kč') + ')' : '' }|"
                                            th:data-price-czk="${priceCzk}"
                                            th:data-price-eur="${priceEur}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('selectedRoofColorId')}" class="attribute-select-error">Vyberte prosím barvu střechy.</div>
                            </div>
                        </div>
                        <div th:if="${availableTaxRates != null and not #lists.isEmpty(availableTaxRates)}" class="mb-3">
                            <label for="taxRateSelect" class="form-label fw-bold">Režim DPH <span class="text-danger">*</span></label>
                            <select class="form-select" id="taxRateSelect" th:field="*{selectedTaxRateId}" required>
                                <option value="" disabled th:text="'-- Vyberte režim DPH --'" th:if="${#lists.size(availableTaxRates) > 1}" th:selected="${cartItemDto.selectedTaxRateId == null}"></option>
                                <option th:each="rate : ${availableTaxRates}"
                                        th:value="${rate.id}"
                                        th:text="|${rate.name} (${#numbers.formatDecimal(rate.rate.multiply(100), 1, 'POINT', 0, 'POINT')}%) ${rate.reverseCharge ? '(PDP)' : ''}|"
                                        th:selected="${#lists.size(availableTaxRates) == 1 or (cartItemDto.selectedTaxRateId != null and cartItemDto.selectedTaxRateId == rate.id)}">
                                    Sazba DPH (Režim)
                                </option>
                            </select>
                            <div th:if="${#fields.hasErrors('selectedTaxRateId')}" class="attribute-select-error">
                                Vyberte prosím režim DPH.
                            </div>
                        </div>
                        <div th:if="${availableTaxRates == null or #lists.isEmpty(availableTaxRates)}" class="alert alert-warning small p-2">
                            Pro tento produkt nejsou definovány žádné daňové sazby. Kontaktujte prosím podporu.
                        </div>
                    </div><div class="addons-section mt-4" th:if="${groupedAddons != null and not groupedAddons.isEmpty()}">
                    <h3 class="h5 mb-3">Volitelné doplňky</h3>

                    <div th:each="categoryEntry : ${groupedAddons}" class="addon-category-group mb-3">
                        <label th:for="'addonCategory_' + ${#strings.replace(categoryEntry.key, ' ', '_')}" class="form-label" th:text="${categoryEntry.key}">Název Kategorie</label>
                        <select class="form-select addon-category-select config-input"
                                th:id="'addonCategory_' + ${#strings.replace(categoryEntry.key, ' ', '_')}"
                                name="selectedAddonsInternal" th:attr="data-category=${categoryEntry.key}">
                            <option value=""
                                    data-addon-id=""
                                    data-pricing-type="NONE"
                                    data-price-czk="0"
                                    data-price-eur="0"
                                    data-price-per-unit-czk="0"
                                    data-price-per-unit-eur="0"
                                    selected> -- Bez doplňku -- </option>
                            <option th:each="addon : ${categoryEntry.value}" th:if="${addon.active}"
                                    th:value="${addon.id}"
                                    th:with="priceCzk=${addon.priceCZK ?: (addon.pricePerUnitCZK != null ? '...' : 0)}, priceEur=${addon.priceEUR ?: (addon.pricePerUnitEUR != null ? '...' : 0)}, unitPriceCzk=${addon.pricePerUnitCZK ?: 0}, unitPriceEur=${addon.pricePerUnitEUR ?: 0}"
                                    th:text="|${addon.name} ${addon.pricingType == 'FIXED' ? '(' + #numbers.formatDecimal(currentGlobalCurrency == 'EUR' ? priceEur : priceCzk, 1, 'POINT', 2, 'COMMA') + ' ' + (currentGlobalCurrency == 'EUR' ? '€' : 'Kč') + ')' : (addon.pricingType != 'NONE' ? '(dle rozměrů)' : '') }|"
                                    th:data-addon-id="${addon.id}"
                                    th:data-pricing-type="${addon.pricingType}"
                                    th:data-price-czk="${addon.priceCZK ?: 0}"
                                    th:data-price-eur="${addon.priceEUR ?: 0}"
                                    th:data-price-per-unit-czk="${unitPriceCzk}"
                                    th:data-price-per-unit-eur="${unitPriceEur}">
                            </option>
                        </select>
                        <div th:id="'addonError_' + ${#strings.replace(categoryEntry.key, ' ', '_')}" class="addon-select-error"></div>
                    </div>

                    <div id="hidden-selected-addons"></div>
                    <div th:if="${#fields.hasErrors('selectedAddons')}" class="error mt-2" th:errors="*{selectedAddons}"></div>

                </div>
                    <div class="row mt-4 align-items-center">
                        <div class="col-auto">
                            <label for="quantity" class="form-label fw-bold">Množství:</label>
                        </div>
                        <div class="col-auto">
                            <input type="number" class="form-control config-input" style="width: 80px;" id="quantity" th:field="*{quantity}" value="1" min="1" max="99" required />
                        </div>
                        <div th:if="${#fields.hasErrors('quantity')}" class="col error ps-0">Zadejte platné množství.</div>
                    </div>

                    <div class="d-grid gap-2 mt-3">
                        <button type="submit" class="btn btn-success btn-lg w-100"
                                id="add-to-cart-btn"
                                th:disabled="${configuratorError != null or initialCustomPriceError != null or productError != null}"> <i class="bi bi-cart-plus-fill me-2"></i> Přidat do košíku
                        </button>
                    </div>
                </form> </div> </div> <div class="row mt-5" th:if="${product != null and configuratorError == null and productError == null}" th:object="${product}">
        <div class="col">
            <h2>Základní specifikace</h2>
            <p>Přesné rozměry a vzhled volíte v konfigurátoru výše.</p>
            <table class="table table-striped table-sm">
                <tbody>
                <tr th:if="${product.material}"><th>Základní materiál</th><td th:text="${product.material}"></td></tr>
                <tr th:if="${availableTaxRates != null and #lists.size(availableTaxRates) == 1}">
                    <th th:text="${availableTaxRates[0].reverseCharge ? 'Režim DPH:' : 'Sazba DPH:'}"></th>
                    <td th:text="${availableTaxRates[0].name} + ' (' + ${#numbers.formatDecimal(availableTaxRates[0].rate.multiply(100), 1, 'POINT', 0, 'POINT')} + '%)' + ${availableTaxRates[0].reverseCharge ? ' (PDP)' : ''}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    </div> </section>

<th:block layout:fragment="javascript">
    <script th:src="@{/js/product-configurator.js}" defer></script>
</th:block>

</body>
</html>