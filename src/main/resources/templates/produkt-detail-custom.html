<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${product?.name ?: 'Produkt na míru'}">Produkt na míru</title>
    <meta name="description" th:content="${product?.metaDescription != null ? product.metaDescription : (#strings.isEmpty(product?.description) ? 'Navrhněte si dřevník na míru.' : #strings.abbreviate(product.description, 160))}" layout:fragment="meta-description"/>

    <th:block layout:fragment="css">
        <style>
            /* Styly zůstávají stejné jako v předchozí verzi */
            .product-images img.main-image { max-width: 100%; height: auto; display: block; margin-bottom: 15px; border: 1px solid #dee2e6; cursor: pointer; background-color: #fff; padding: 0.25rem; border-radius: 0.375rem; }
            .product-thumbnails { display: flex; gap: 8px; flex-wrap: wrap; }
            .product-thumbnails img { width: 80px; height: 80px; object-fit: cover; border: 2px solid #dee2e6; cursor: pointer; opacity: 0.7; border-radius: 0.25rem; transition: opacity 0.2s ease-in-out, border-color 0.2s ease-in-out; }
            .product-thumbnails img:hover { opacity: 1.0; }
            .product-thumbnails img.active { border-color: var(--bs-primary); opacity: 1.0; }
            .price { font-size: 1.8em; font-weight: bold; color: var(--bs-danger); margin-bottom: 15px; min-height: 1.2em; transition: opacity 0.2s ease-in-out; }
            .price.calculating { opacity: 0.6; }
            .price-eur { font-size: 0.8em; color: #6c757d; }
            .configurator-section, .addons-section { border: 1px solid #e0e0e0; padding: 1.5rem; margin-top: 1.5rem; background-color: #f8f9fa; border-radius: 0.375rem; margin-bottom: 1.5rem; }
            .range-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 0.5rem; }
            .range-container label { min-width: 100px; }
            .range-container .form-range { flex: 1 1 auto; min-width: 150px; }
            .range-container .range-value { display: inline-block; width: 65px; text-align: right; vertical-align: middle; font-family: monospace; font-weight: bold; background-color:#e9ecef; padding: .1rem .3rem; border-radius: .25rem; font-size: 0.9em;}
            .range-container small { flex-basis: 100%; margin-left: 110px; font-size: 0.8em; color: #6c757d; margin-top: -0.3rem; }
            .error { color: var(--bs-danger); font-size: 0.875em; display: block; margin-top: 0.25rem; }
            .form-check-label.checkbox-label { margin-left: 0.3rem; font-weight: normal; }
            .price .spinner-border-sm { vertical-align: middle; margin-left: 5px; }
            /* Specific style for attribute select error messages */
            .attribute-select-error { color: var(--bs-danger); font-size: 0.875em; display: block; margin-top: 0.25rem; }
        </style>
    </th:block>

    <script type="application/ld+json" th:inline="javascript">
        //<![CDATA[
        { /* ... JSON-LD obsah ... */ }
        //]]>
    </script>
</head>
<body>

<section layout:fragment="content">
    <div class="container mt-5">
        <div th:if="${cartSuccess}" class="alert alert-success alert-dismissible fade show" role="alert">...</div>
        <div th:if="${cartError}" class="alert alert-danger alert-dismissible fade show" role="alert">...</div>
        <div th:if="${configuratorError != null}" class="alert alert-warning" role="alert" th:text="${configuratorError}">...</div>

        <div class="row" th:if="${product != null and configuratorError == null}" th:object="${product}">
            <div class="col-lg-6 product-images mb-4 mb-lg-0">
                <img th:if="*{images != null and not #lists.isEmpty(images)}" th:src="*{images[0].url}" th:alt="*{name}" id="mainProductImage" class="main-image img-fluid shadow-sm" />
                <img th:unless="*{images != null and not #lists.isEmpty(images)}" th:src="@{/images/placeholder.png}" alt="Produkt bez obrázku" class="main-image img-fluid shadow-sm"/>
                <div class="product-thumbnails mt-3" th:if="*{images != null and #lists.size(images) > 1}">
                    <img th:each="img, iter : *{images}" th:src="${img.url}" th:alt="*{name + ' - náhled ' + (iter.index + 1)}" th:classappend="${iter.index == 0} ? 'active'" th:data-img-url="${img.url}" onclick="changeMainImage(this)"/>
                </div>
            </div>

            <div class="col-lg-6 product-info">
                <h1 class="mb-3" th:text="*{name}">Produkt na míru</h1>
                <div class="price mb-2" id="product-price-display">...</div>
                <div id="customPriceErrorDisplay" class="error mb-3" style="display: none;"></div>
                <div th:utext="*{description}" class="mb-4">...</div>
                <hr class="mb-4"/>

                <form th:action="@{/kosik/pridat}" method="post" id="add-to-cart-form" th:object="${cartItemDto}"
                      th:data-product-id="${product.id}"
                      th:data-initial-czk="${initialCustomPriceCZK}"
                      th:data-initial-eur="${initialCustomPriceEUR}"
                      th:data-initial-error="${initialCustomPriceError}"
                      th:data-calculate-url="@{/api/product/calculate-price}"
                      th:data-currency-symbol="${currentGlobalCurrency == 'EUR' ? '€' : 'Kč'}">

                    <input type="hidden" th:field="*{productId}" />
                    <input type="hidden" th:field="*{custom}" value="true" />

                    <div class="configurator-section" th:if="${configurator != null}">
                        <h3 class="h5 mb-3">Navrhněte si vlastní rozměry a vzhled</h3>

                        <div class="mb-3 range-container">
                            <label for="customLength" class="form-label">Šířka (délka):</label>
                            <input type="range" class="form-range dimension-slider" id="customLength" name="customDimensions[length]"
                                   th:min="${configurator.minLength ?: 100}" th:max="${configurator.maxLength ?: 500}" th:step="${configurator.stepLength ?: 10}"
                                   th:value="*{customDimensions['length'] ?: configurator.defaultLength ?: configurator.minLength}" />
                            <span class="range-value"><span id="customLengthValueDisplay">...</span> cm</span>
                            <small th:if="${configurator.minLength != null and configurator.maxLength != null}"
                                   th:text="'[' + ${#numbers.formatDecimal(configurator.minLength, 1, 1)} + ' - ' + ${#numbers.formatDecimal(configurator.maxLength, 1, 1)} + ' cm]'"
                                   class="text-muted"></small>
                        </div>
                        <div class="mb-3 range-container">
                            <label for="customWidth" class="form-label">Hloubka (šířka):</label>
                            <input type="range" class="form-range dimension-slider" id="customWidth" name="customDimensions[width]"
                                   th:min="${configurator.minWidth ?: 50}" th:max="${configurator.maxWidth ?: 200}" th:step="${configurator.stepWidth ?: 10}"
                                   th:value="*{customDimensions['width'] ?: configurator.defaultWidth ?: configurator.minWidth}" />
                            <span class="range-value"><span id="customWidthValueDisplay">...</span> cm</span>
                            <small th:if="${configurator.minWidth != null and configurator.maxWidth != null}"
                                   th:text="'[' + ${#numbers.formatDecimal(configurator.minWidth, 1, 1)} + ' - ' + ${#numbers.formatDecimal(configurator.maxWidth, 1, 1)} + ' cm]'"
                                   class="text-muted"></small>
                        </div>
                        <div class="mb-3 range-container">
                            <label for="customHeight" class="form-label">Výška:</label>
                            <input type="range" class="form-range dimension-slider" id="customHeight" name="customDimensions[height]"
                                   th:min="${configurator.minHeight ?: 150}" th:max="${configurator.maxHeight ?: 300}" th:step="${configurator.stepHeight ?: 5}"
                                   th:value="*{customDimensions['height'] ?: configurator.defaultHeight ?: configurator.minHeight}" />
                            <span class="range-value"><span id="customHeightValueDisplay">...</span> cm</span>
                            <small th:if="${configurator.minHeight != null and configurator.maxHeight != null}"
                                   th:text="'[' + ${#numbers.formatDecimal(configurator.minHeight, 1, 1)} + ' - ' + ${#numbers.formatDecimal(configurator.maxHeight, 1, 1)} + ' cm]'"
                                   class="text-muted"></small>
                        </div>

                        <hr>
                        <div class="row g-3">
                            <div class="col-md-6 mb-3">
                                <label for="designSelect" class="form-label fw-bold">Design:</label>
                                <select class="form-select config-input" id="designSelect" th:field="*{selectedDesignId}" required>
                                    <option value="" disabled selected>-- Vyberte design --</option>
                                    <option th:each="designOpt : ${availableDesigns}"
                                            th:value="${designOpt.id}"
                                            th:text="|${designOpt.name} ${ (designOpt.priceSurchargeCZK != null and designOpt.priceSurchargeCZK.doubleValue() > 0) ? '(+ ' + #numbers.formatDecimal(currentGlobalCurrency == 'EUR' ? designOpt.priceSurchargeEUR : designOpt.priceSurchargeCZK, 1, 'DEFAULT', 2, 'DEFAULT') + ' ' + currentGlobalCurrency + ')' : '' }|"
                                            th:data-price-czk="${designOpt.priceSurchargeCZK ?: 0}"
                                            th:data-price-eur="${designOpt.priceSurchargeEUR ?: 0}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('selectedDesignId')}" class="attribute-select-error">Vyberte prosím design.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="glazeSelect" class="form-label fw-bold">Lazura:</label>
                                <select class="form-select config-input" id="glazeSelect" th:field="*{selectedGlazeId}" required>
                                    <option value="" disabled selected>-- Vyberte lazuru --</option>
                                    <option th:each="glazeOpt : ${availableGlazes}"
                                            th:value="${glazeOpt.id}"
                                            th:text="|${glazeOpt.name} ${ (glazeOpt.priceSurchargeCZK != null and glazeOpt.priceSurchargeCZK.doubleValue() > 0) ? '(+ ' + #numbers.formatDecimal(currentGlobalCurrency == 'EUR' ? glazeOpt.priceSurchargeEUR : glazeOpt.priceSurchargeCZK, 1, 'DEFAULT', 2, 'DEFAULT') + ' ' + currentGlobalCurrency + ')' : '' }|"
                                            th:data-price-czk="${glazeOpt.priceSurchargeCZK ?: 0}"
                                            th:data-price-eur="${glazeOpt.priceSurchargeEUR ?: 0}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('selectedGlazeId')}" class="attribute-select-error">Vyberte prosím lazuru.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="roofColorSelect" class="form-label fw-bold">Barva střechy:</label>
                                <select class="form-select config-input" id="roofColorSelect" th:field="*{selectedRoofColorId}" required>
                                    <option value="" disabled selected>-- Vyberte barvu --</option>
                                    <option th:each="colorOpt : ${availableRoofColors}"
                                            th:value="${colorOpt.id}"
                                            th:text="|${colorOpt.name} ${ (colorOpt.priceSurchargeCZK != null and colorOpt.priceSurchargeCZK.doubleValue() > 0) ? '(+ ' + #numbers.formatDecimal(currentGlobalCurrency == 'EUR' ? colorOpt.priceSurchargeEUR : colorOpt.priceSurchargeCZK, 1, 'DEFAULT', 2, 'DEFAULT') + ' ' + currentGlobalCurrency + ')' : '' }|"
                                            th:data-price-czk="${colorOpt.priceSurchargeCZK ?: 0}"
                                            th:data-price-eur="${colorOpt.priceSurchargeEUR ?: 0}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('selectedRoofColorId')}" class="attribute-select-error">Vyberte prosím barvu střechy.</div>
                            </div>
                        </div>
                        <hr>
                        <h6 class="mt-3 mb-2">Volitelné prvky:</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input custom-feature-checkbox config-input" type="checkbox" id="customHasDivider" th:field="*{customHasDivider}" value="true" />
                            <label class="form-check-label checkbox-label" for="customHasDivider">Příčka</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input custom-feature-checkbox config-input" type="checkbox" id="customHasGutter" th:field="*{customHasGutter}" value="true" />
                            <label class="form-check-label checkbox-label" for="customHasGutter">Okap</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input custom-feature-checkbox config-input" type="checkbox" id="customHasGardenShed" th:field="*{customHasGardenShed}" value="true" />
                            <label class="form-check-label checkbox-label" for="customHasGardenShed">Zahradní domek</label>
                        </div>
                    </div> <div class="addons-section mt-4" th:if="${availableAddons != null and not #lists.isEmpty(availableAddons)}">
                    <h3 class="h5 mb-3">Volitelné doplňky:</h3>
                    <div th:each="addon, iter : ${availableAddons}" th:if="${addon.active}" class="form-check mb-2">
                        <input class="form-check-input fixed-addon-checkbox" type="checkbox"
                               th:id="'addon_' + ${addon.id}"
                               th:name="'selectedAddons[' + ${iter.index} + '].addonId'"
                               th:value="${addon.id}" />
                        <label class="form-check-label checkbox-label" th:for="'addon_' + ${addon.id}">
                            <span th:text="${addon.name}">Název doplňku</span>
                            <span class="text-muted ms-2">
                                     (<th:block th:text="${#numbers.formatDecimal(currentGlobalCurrency == 'EUR' ? addon.priceEUR : addon.priceCZK, 1, 'DEFAULT', 2, 'DEFAULT')}"/>&nbsp;<th:block th:text="${currentGlobalCurrency == 'EUR' ? '€' : 'Kč'}"/>)
                                 </span>
                        </label>
                        <input type="hidden" th:name="'selectedAddons[' + ${iter.index} + '].quantity'" value="1" />
                        <input type="hidden" th:id="'addon_price_czk_' + ${addon.id}" th:value="${addon.priceCZK}">
                        <input type="hidden" th:id="'addon_price_eur_' + ${addon.id}" th:value="${addon.priceEUR}">
                    </div>
                </div>

                    <div class="row mt-4 align-items-center">
                        <div class="col-auto">
                            <label for="quantity" class="form-label">Množství:</label>
                        </div>
                        <div class="col-auto">
                            <input type="number" class="form-control" style="width: 80px;" id="quantity" th:field="*{quantity}" value="1" min="1" max="99" required />
                        </div>
                        <div class="col">
                            <button type="submit" class="btn btn-success btn-lg w-100"
                                    id="add-to-cart-btn"
                                    th:disabled="${configuratorError != null or initialCustomPriceError != null}">
                                <i class="bi bi-cart-plus-fill me-2"></i> Přidat do košíku
                            </button>
                        </div>
                    </div>
                </form> </div> </div> <div class="row mt-5" th:if="${product != null and configuratorError == null}" th:object="${product}">
        <div class="col">
            <h2>Základní parametry</h2>
            <p>Přesné rozměry a vzhled volíte v konfigurátoru výše.</p>
            <table class="table table-striped table-sm">
                <tbody>
                <tr th:if="${product.material}"><th>Základní materiál</th><td th:text="${product.material}"></td></tr>
                <tr th:if="${product.taxRate}"><th>Sazba DPH</th><td th:text="${#numbers.formatDecimal(product.taxRate.rate * 100, 1, 'DEFAULT', 0, 'POINT')} + '%'"></td></tr>
                <tr th:if="${product.taxRate != null and product.taxRate.reverseCharge}"><th>Režim DPH</th><td>Přenesená daňová povinnost</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    </div> </section>

<th:block layout:fragment="scripts">
    <script th:src="@{/js/product-configurator.js}"></script>
</th:block>

</body>
</html>