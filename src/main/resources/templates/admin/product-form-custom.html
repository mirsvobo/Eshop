<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout/admin-layout}">
<head>
    <title th:text="${product.id == null} ? 'Přidat produkt na míru' : 'Upravit produkt na míru: ' + ${product.name}">Přidat/Upravit Produkt Na Míru</title>
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <style>
        /* Styly pro náhled obrázků a zprávy (můžete přesunout do admin CSS) */
        .image-preview { position: relative; display: inline-block; margin: 5px; vertical-align: top; }
        .image-preview img { max-width: 100px; max-height: 100px; display: block; border: 1px solid #ddd; }
        .alert-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .invalid-feedback.d-block { display: block !important; }
        #imageMessages .alert { margin-top: 10px; }
        .spinner-border-sm { width: 1rem; height: 1rem; border-width: .2em; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <h1 th:text="${product.id == null} ? 'Přidat produkt na míru' : 'Upravit produkt na míru'"></h1>
    <p class="text-muted">Formulář pro produkty, kde si zákazník volí vlastní rozměry, atributy a doplňky.</p>

    <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
    <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>

    <form th:action="${product.id == null} ? @{/admin/products/custom} : @{/admin/products/{id}(id=${product.id})}"
          th:object="${product}" method="post" enctype="multipart/form-data" id="productFormCustom">

        <input type="hidden" th:field="*{id}" />
        <input type="hidden" th:field="*{version}" />
        <input type="hidden" th:field="*{customisable}" th:value="true"/>

        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger" role="alert">
            Prosím opravte následující chyby:
            <ul>
                <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
            </ul>
        </div>

        <div class="mb-3">
            <label for="name" class="form-label">Název produktu:</label>
            <input type="text" class="form-control" id="name" th:field="*{name}">
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
        </div>
        <div class="mb-3">
            <label for="shortDescription" class="form-label">Krátký popis (max 500 znaků):</label>
            <textarea class="form-control" id="shortDescription" th:field="*{shortDescription}" rows="3" maxlength="500"></textarea>
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('shortDescription')}" th:errors="*{shortDescription}"></div>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Hlavní Popis:</label>
            <textarea class="form-control" id="description" th:field="*{description}" rows="5"></textarea>
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="model" class="form-label">Model:</label>
                <input type="text" class="form-control" id="model" th:field="*{model}">
                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('model')}" th:errors="*{model}"></div>
            </div>
            <div class="col-md-6">
                <label for="material" class="form-label">Materiál:</label>
                <input type="text" class="form-control" id="material" th:field="*{material}">
                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('material')}" th:errors="*{material}"></div>
            </div>
        </div>
        <div class="mb-3">
            <label for="slug" class="form-label">URL Slug (nepovinné, vygeneruje se z názvu):</label>
            <input type="text" class="form-control" id="slug" th:field="*{slug}">
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('slug')}" th:errors="*{slug}"></div>
        </div>
        <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="active" th:field="*{active}">
            <label class="form-check-label" for="active">Aktivní (viditelný v e-shopu)</label>
        </div>

        <hr>
        <h4>Daňové sazby <span class="text-danger">*</span></h4>
        <div class="mb-3">
            <label class="form-label">Přiřazené daňové sazby (alespoň jedna):</label>
            <div th:if="${allTaxRates == null or #lists.isEmpty(allTaxRates)}" class="alert alert-light alert-sm">
                Nebyly nalezeny žádné aktivní daňové sazby. Můžete je vytvořit v sekci <a th:href="@{/admin/tax-rates}">Daňové sazby</a>.
            </div>
            <div th:each="rate : ${allTaxRates}" class="form-check">
                <input class="form-check-input" type="checkbox" name="availableTaxRates" th:value="${rate.id}" th:id="'taxRate_' + ${rate.id}"
                       th:checked="${product.availableTaxRates != null and #sets.contains(product.availableTaxRates, rate)}">
                <label class="form-check-label" th:for="'taxRate_' + ${rate.id}" th:text="${rate.name + ' (' + #numbers.formatDecimal(rate.rate * 100, 0, 'POINT', 0, 'COMMA') + ' %)'}"></label>
            </div>
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('availableTaxRates')}" th:errors="*{availableTaxRates}"></div>
            <th:block th:if="${#fields.hasGlobalErrors()}">
                <div class="text-danger small mt-1" th:each="err : ${#fields.globalErrors()}" th:if="${#strings.containsIgnoreCase(err, 'tax rate')}" th:text="${err}"></div>
            </th:block>
        </div>

        <hr>
        <h4>Konfigurátor produktu na míru</h4>
        <th:block th:if="${product.configurator != null}">
            <div id="configuratorSettings">
                <h5>Rozměry (v cm) - zadejte rozmezí, výchozí hodnoty a krok</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.minLength" class="form-label">Min. Délka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.minLength" th:field="*{configurator.minLength}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.minLength')}" th:errors="*{configurator.minLength}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.maxLength" class="form-label">Max. Délka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.maxLength" th:field="*{configurator.maxLength}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.maxLength')}" th:errors="*{configurator.maxLength}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.defaultLength" class="form-label">Výchozí Délka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.defaultLength" th:field="*{configurator.defaultLength}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.defaultLength')}" th:errors="*{configurator.defaultLength}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.stepLength" class="form-label">Krok Délky:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.stepLength" th:field="*{configurator.stepLength}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.stepLength')}" th:errors="*{configurator.stepLength}"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.minWidth" class="form-label">Min. Šířka/Hloubka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.minWidth" th:field="*{configurator.minWidth}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.minWidth')}" th:errors="*{configurator.minWidth}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.maxWidth" class="form-label">Max. Šířka/Hloubka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.maxWidth" th:field="*{configurator.maxWidth}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.maxWidth')}" th:errors="*{configurator.maxWidth}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.defaultWidth" class="form-label">Výchozí Šířka/Hloubka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.defaultWidth" th:field="*{configurator.defaultWidth}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.defaultWidth')}" th:errors="*{configurator.defaultWidth}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.stepWidth" class="form-label">Krok Šířky/Hloubky:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.stepWidth" th:field="*{configurator.stepWidth}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.stepWidth')}" th:errors="*{configurator.stepWidth}"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.minHeight" class="form-label">Min. výška:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.minHeight" th:field="*{configurator.minHeight}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.minHeight')}" th:errors="*{configurator.minHeight}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.maxHeight" class="form-label">Max. výška:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.maxHeight" th:field="*{configurator.maxHeight}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.maxHeight')}" th:errors="*{configurator.maxHeight}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.defaultHeight" class="form-label">Výchozí výška:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.defaultHeight" th:field="*{configurator.defaultHeight}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.defaultHeight')}" th:errors="*{configurator.defaultHeight}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.stepHeight" class="form-label">Krok výšky:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.stepHeight" th:field="*{configurator.stepHeight}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.stepHeight')}" th:errors="*{configurator.stepHeight}"></div>
                    </div>
                </div>
                <p class="form-text text-muted">
                    Zadejte limity, výchozí hodnoty a krok pro každý rozměr. Výchozí hodnota a krok musí být v rámci min/max limitů.
                </p>

                <h5>Ceny za rozměry (bez DPH)</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmLengthCZK" class="form-label">Cena/cm délky (CZK):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmLengthCZK" th:field="*{configurator.pricePerCmLengthCZK}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmLengthCZK')}" th:errors="*{configurator.pricePerCmLengthCZK}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmWidthCZK" class="form-label">Cena/cm Šířky/Hloubky (CZK):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmWidthCZK" th:field="*{configurator.pricePerCmWidthCZK}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmWidthCZK')}" th:errors="*{configurator.pricePerCmWidthCZK}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmHeightCZK" class="form-label">Cena/cm výšky (CZK):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmHeightCZK" th:field="*{configurator.pricePerCmHeightCZK}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmHeightCZK')}" th:errors="*{configurator.pricePerCmHeightCZK}"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmLengthEUR" class="form-label">Cena/cm délky (EUR):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmLengthEUR" th:field="*{configurator.pricePerCmLengthEUR}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmLengthEUR')}" th:errors="*{configurator.pricePerCmLengthEUR}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmWidthEUR" class="form-label">Cena/cm Šířky/Hloubky (EUR):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmWidthEUR" th:field="*{configurator.pricePerCmWidthEUR}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmWidthEUR')}" th:errors="*{configurator.pricePerCmWidthEUR}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmHeightEUR" class="form-label">Cena/cm výšky (EUR):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmHeightEUR" th:field="*{configurator.pricePerCmHeightEUR}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmHeightEUR')}" th:errors="*{configurator.pricePerCmHeightEUR}"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Dostupné doplňky pro konfiguraci na míru:</label>
                    <p class="form-text text-muted">Zaškrtněte doplňky, které si zákazník bude moci k tomuto produktu přidat. Ceny doplňků se nastavují v sekci Doplňky.</p>
                    <div th:if="${allAddons == null or #lists.isEmpty(allAddons)}" class="alert alert-light alert-sm">
                        Nebyly nalezeny žádné aktivní doplňky. Můžete je vytvořit v sekci <a th:href="@{/admin/addons}">Doplňky</a>.
                    </div>
                    <div th:each="addon : ${allAddons}" class="form-check">
                        <input class="form-check-input" type="checkbox" name="availableAddons" th:value="${addon.id}" th:id="'addon_' + ${addon.id}"
                               th:checked="${product.availableAddons != null and #sets.contains(product.availableAddons, addon)}">
                        <label class="form-check-label" th:for="'addon_' + ${addon.id}" th:text="${addon.name + ' (' + addon.category + ' - ' + addon.pricingType + ')'}"></label>
                        <small class="text-muted ms-2"
                               th:text="${addon.pricingType == 'FIXED' ?
                                          ('Fix: ' + (addon.priceCZK ?: '0') + ' Kč / ' + (addon.priceEUR ?: '0') + ' €') :
                                          ('Jedn.: ' + (addon.pricePerUnitCZK ?: '0') + ' Kč / ' + (addon.pricePerUnitEUR ?: '0') + ' €') }"></small>
                    </div>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('availableAddons')}" th:errors="*{availableAddons}"></div>
                </div>

                <hr>
                <h5>Dostupné atributy pro konfiguraci na míru</h5>
                <p class="form-text text-muted">
                    Zaškrtněte možnosti, které si zákazník bude moci zvolit v konfigurátoru na e-shopu.
                    Příplatky za jednotlivé možnosti se nastavují v sekcích Designy, Lazury, Barvy střechy.
                </p>

                <div class="mb-3">
                    <label class="form-label">Dostupné designy:</label>
                    <div th:if="${allDesigns == null or #lists.isEmpty(allDesigns)}" class="alert alert-light alert-sm">
                        Nebyly nalezeny žádné aktivní designy. Můžete je vytvořit v sekci <a th:href="@{/admin/designs}">Designy</a>.
                    </div>
                    <div th:each="design : ${allDesigns}" class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="availableDesigns" th:value="${design.id}" th:id="'design_' + ${design.id}"
                               th:checked="${product.availableDesigns != null and #sets.contains(product.availableDesigns, design)}">
                        <label class="form-check-label" th:for="'design_' + ${design.id}" th:text="${design.name}"></label>
                    </div>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('availableDesigns')}" th:errors="*{availableDesigns}"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Dostupné lazury:</label>
                    <div th:if="${allGlazes == null or #lists.isEmpty(allGlazes)}" class="alert alert-light alert-sm">
                        Nebyly nalezeny žádné aktivní lazury. Můžete je vytvořit v sekci <a th:href="@{/admin/glazes}">Lazury</a>.
                    </div>
                    <div th:each="glaze : ${allGlazes}" class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="availableGlazes" th:value="${glaze.id}" th:id="'glaze_' + ${glaze.id}"
                               th:checked="${product.availableGlazes != null and #sets.contains(product.availableGlazes, glaze)}">
                        <label class="form-check-label" th:for="'glaze_' + ${glaze.id}" th:text="${glaze.name}"></label>
                    </div>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('availableGlazes')}" th:errors="*{availableGlazes}"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Dostupné barvy střechy:</label>
                    <div th:if="${allRoofColors == null or #lists.isEmpty(allRoofColors)}" class="alert alert-light alert-sm">
                        Nebyly nalezeny žádné aktivní barvy střechy. Můžete je vytvořit v sekci <a th:href="@{/admin/roof-colors}">Barvy střechy</a>.
                    </div>
                    <div th:each="roofColor : ${allRoofColors}" class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="availableRoofColors" th:value="${roofColor.id}" th:id="'roofColor_' + ${roofColor.id}"
                               th:checked="${product.availableRoofColors != null and #sets.contains(product.availableRoofColors, roofColor)}">
                        <label class="form-check-label" th:for="'roofColor_' + ${roofColor.id}" th:text="${roofColor.name}"></label>
                    </div>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('availableRoofColors')}" th:errors="*{availableRoofColors}"></div>
                </div>
            </div> </th:block> <div th:if="${product.configurator == null}" class="alert alert-warning mt-3">
        Konfigurátor pro tento produkt nebyl nalezen nebo inicializován. Zkontrolujte data produktu nebo kontaktujte administrátora. Uložení formuláře může vytvořit defaultní konfigurátor.
    </div>

        <hr>
        <h4>SEO</h4>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="metaTitle" class="form-label">Meta Title:</label>
                <input type="text" class="form-control" id="metaTitle" th:field="*{metaTitle}">
                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('metaTitle')}" th:errors="*{metaTitle}"></div>
            </div>
            <div class="col-md-6">
                <label for="metaDescription" class="form-label">Meta Description:</label>
                <textarea class="form-control" id="metaDescription" th:field="*{metaDescription}" rows="2"></textarea>
                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('metaDescription')}" th:errors="*{metaDescription}"></div>
            </div>
        </div>

        <hr>
        <h4>Obrázky produktu</h4>
        <div class="mb-3 border p-3 rounded">
            <label class="form-label d-block">Aktuální obrázky:</label>
            <div id="imageMessages">
                <div th:if="${imageError}" class="alert alert-danger alert-sm mt-2" role="alert" th:text="${imageError}"></div>
                <div th:if="${imageSuccess}" class="alert alert-success alert-sm mt-2" role="alert" th:text="${imageSuccess}"></div>
            </div>

            <div id="currentImages">
                <div th:if="${sortedImages == null or #lists.isEmpty(sortedImages)}" class="text-muted mb-2" id="noImagesText">Žádné obrázky nebyly nahrány.</div>
                <div th:each="image : ${sortedImages}"
                     class="image-preview d-flex align-items-center mb-2 border-bottom pb-2" th:id="'image-preview-' + ${image.id}">
                    <img th:src="@{${image.url}}" th:alt="${image.altText ?: 'Náhled'}" style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px;">
                    <div class="flex-grow-1">
                        <input type="number" class="form-control form-control-sm mb-1 image-order-input" th:value="${image.displayOrder}" min="0" placeholder="Pořadí" th:data-image-id="${image.id}">
                        <small th:text="${image.url}"></small>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm ms-2 delete-image-btn" title="Smazat obrázek" th:data-image-id="${image.id}" th:data-product-id="${product.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <button type="button" id="updateImageOrderBtn" class="btn btn-outline-secondary btn-sm mt-2" style="display: none;" th:if="${product.id != null}">Aktualizovat pořadí</button>


            <div class="mt-3 pt-3 border-top" th:if="${product.id != null}">
                <h5>Nahrát nový obrázek</h5>
                <div class="mb-2">
                    <label for="newImageFile" class="form-label">Soubor:</label>
                    <input type="file" class="form-control form-control-sm" id="newImageFile" name="imageFile" accept="image/png, image/jpeg, image/webp, image/gif">
                </div>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label for="newAltText" class="form-label">Alt text:</label>
                        <input type="text" class="form-control form-control-sm" id="newAltText" name="altText">
                    </div>
                    <div class="col-md-4">
                        <label for="newTitleText" class="form-label">Title text:</label>
                        <input type="text" class="form-control form-control-sm" id="newTitleText" name="titleText">
                    </div>
                    <div class="col-md-4">
                        <label for="newDisplayOrder" class="form-label">Pořadí:</label>
                        <input type="number" class="form-control form-control-sm" id="newDisplayOrder" name="displayOrder" placeholder="Auto">
                    </div>
                </div>
                <button type="button" id="uploadImageBtnAjax" class="btn btn-success btn-sm mt-2">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                    <i class="bi bi-upload"></i> Nahrát obrázek
                </button>
            </div>
        </div> <hr>
        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> [[${product.id == null ? 'Vytvořit produkt' : 'Uložit změny'}]]</button>
        <a th:href="@{/admin/products}" class="btn btn-secondary">Zrušit</a>

    </form>
</div>
<th:block layout:fragment="javascript">
    <script th:src="@{/js/product-configurator.js}"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // --- Definice datového objektu pro JS ---
        const configuratorInitData = {
            calculatePriceUrl: /*[[@{/api/product/calculate-price}]]*/ '/api/product/calculate-price',
            currency: /*[[${currentGlobalCurrency}]]*/ 'CZK',
            csrfToken: /*[[${_csrf?.token}]]*/ null,
            csrfHeaderName: /*[[${_csrf?.headerName}]]*/ null,
            productId: /*[[${product.id}]]*/ null,
            configuratorValues: {
                minLength: /*[[${product.configurator?.minLength}]]*/ null,
                maxLength: /*[[${product.configurator?.maxLength}]]*/ null,
                stepLength: /*[[${product.configurator?.stepLength}]]*/ null,
                defaultLength: /*[[${product.configurator?.defaultLength ?: product.configurator?.minLength}]]*/ null,
                minWidth: /*[[${product.configurator?.minWidth}]]*/ null,
                maxWidth: /*[[${product.configurator?.maxWidth}]]*/ null,
                stepWidth: /*[[${product.configurator?.stepWidth}]]*/ null,
                defaultWidth: /*[[${product.configurator?.defaultWidth ?: product.configurator?.minWidth}]]*/ null,
                minHeight: /*[[${product.configurator?.minHeight}]]*/ null,
                maxHeight: /*[[${product.configurator?.maxHeight}]]*/ null,
                stepHeight: /*[[${product.configurator?.stepHeight}]]*/ null,
                defaultHeight: /*[[${product.configurator?.defaultHeight ?: product.configurator?.minHeight}]]*/ null
            }
        };
        // --- Konec definice dat ---

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializace tooltipů
            const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(tooltipTriggerEl => { new bootstrap.Tooltip(tooltipTriggerEl); });

            // --- VOLÁNÍ INICIALIZAČNÍ FUNKCE z product-configurator.js ---
            if (typeof initializeConfigurator === 'function') {
                initializeConfigurator(configuratorInitData);
                console.log('Product Configurator Initialized via function call.');
            } else {
                console.error('Chyba: Funkce initializeConfigurator nebyla nalezena v product-configurator.js');
                const errorDiv = document.getElementById('customPriceErrorDisplay');
                if(errorDiv) { errorDiv.textContent = 'Chyba načítání konfigurátoru.'; errorDiv.style.display = 'block'; }
                const submitBtn = document.querySelector('#custom-product-form button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
            }
            // --- KONEC VOLÁNÍ ---

            // Bootstrap validace formuláře
            const form = document.getElementById('custom-product-form');
            if(form) {
                form.addEventListener('submit', event => {
                    // ==================================================================
                    // === KROK 3: ZAKOMENTUJ TENTO ŘÁDEK PŘIDÁNÍM // NA ZAČÁTEK ===
                    // ==================================================================
                    if (typeof prepareFormDataBeforeSubmit === 'function') { prepareFormDataBeforeSubmit(); }
                    // else { console.warn('Funkce prepareFormDataBeforeSubmit nebyla nalezena.'); }
                    // ==================================================================

                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        console.warn("Form validation failed before submission.");
                        // Explicitní kontrola a zvýraznění chybějících required prvků
                        form.querySelectorAll('[required]').forEach(el => {
                            if (el.type === 'radio') {
                                const radioGroup = form.querySelectorAll(`input[name="${el.name}"]`);
                                const isChecked = Array.from(radioGroup).some(radio => radio.checked);
                                if (!isChecked) {
                                    const container = el.closest('.tax-selection');
                                    if (container) container.classList.add('is-invalid');
                                } else {
                                    const container = el.closest('.tax-selection');
                                    if (container) container.classList.remove('is-invalid');
                                }
                            } else if (!el.value) {
                                el.classList.add('is-invalid');
                            } else {
                                el.classList.remove('is-invalid');
                            }
                        });
                    }
                    form.classList.add('was-validated');
                }, false);
                // Odstranění třídy is-invalid při změně selectů nebo radio buttonů
                form.querySelectorAll('select[required], input[type="radio"][required]').forEach(el => {
                    el.addEventListener('change', () => {
                        if (el.type === 'radio') {
                            const container = el.closest('.tax-selection');
                            if (container) container.classList.remove('is-invalid');
                        } else {
                            el.classList.remove('is-invalid');
                        }
                    });
                });
            }
        });
        /*]]>*/
    </script>
</th:block>

</body>
</html>