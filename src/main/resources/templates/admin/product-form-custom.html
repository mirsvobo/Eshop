<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout/admin-layout}">
<head>
    <title th:text="${product.id == null} ? 'Přidat produkt na míru' : 'Upravit produkt na míru: ' + ${product.name}">Přidat/Upravit Produkt Na Míru</title>
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <style>
        .image-preview { position: relative; display: inline-block; margin: 5px; vertical-align: top; }
        .image-preview img { max-width: 100px; max-height: 100px; display: block; border: 1px solid #ddd; }
        .alert-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .invalid-feedback.d-block { display: block !important; }
        #imageMessages .alert { margin-top: 10px; }
        .spinner-border-sm { width: 1rem; height: 1rem; border-width: .2em; } /* Menší spinner */
    </style>
</head>
<body>
<div layout:fragment="content">
    <h1 th:text="${product.id == null} ? 'Přidat produkt na míru' : 'Upravit produkt na míru'"></h1>
    <p class="text-muted">Formulář pro produkty, kde si zákazník volí vlastní rozměry a doplňky.</p>

    <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
    <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>

    <form th:action="${product.id == null} ? @{/admin/products/custom} : @{/admin/products/{id}(id=${product.id})}"
          th:object="${product}" method="post" enctype="multipart/form-data" id="productFormCustom">

        <input type="hidden" th:field="*{id}" />
        <input type="hidden" th:field="*{version}" />
        <input type="hidden" th:field="*{customisable}" th:value="true"/>

        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger" role="alert">
            Prosím opravte následující chyby:
            <ul>
                <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
            </ul>
        </div>

        <div class="mb-3">
            <label for="name" class="form-label">Název produktu:</label>
            <input type="text" class="form-control" id="name" th:field="*{name}">
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
        </div>
        <div class="mb-3">
            <label for="shortDescription" class="form-label">Krátký popis (max 500 znaků):</label>
            <textarea class="form-control" id="shortDescription" th:field="*{shortDescription}" rows="3" maxlength="500"></textarea>
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('shortDescription')}" th:errors="*{shortDescription}"></div>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Hlavní Popis:</label>
            <textarea class="form-control" id="description" th:field="*{description}" rows="5"></textarea>
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="model" class="form-label">Model:</label>
                <input type="text" class="form-control" id="model" th:field="*{model}">
                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('model')}" th:errors="*{model}"></div>
            </div>
            <div class="col-md-6">
                <label for="material" class="form-label">Materiál:</label>
                <input type="text" class="form-control" id="material" th:field="*{material}">
                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('material')}" th:errors="*{material}"></div>
            </div>
        </div>
        <div class="mb-3">
            <label for="slug" class="form-label">URL Slug (nepovinné, vygeneruje se z názvu):</label>
            <input type="text" class="form-control" id="slug" th:field="*{slug}">
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('slug')}" th:errors="*{slug}"></div>
        </div>
        <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="active" th:field="*{active}">
            <label class="form-check-label" for="active">Aktivní (viditelný v e-shopu)</label>
        </div>

        <hr>
        <h4>Daňové sazby <span class="text-danger">*</span></h4>
        <div class="mb-3">
            <label class="form-label">Přiřazené daňové sazby (alespoň jedna):</label>
            <div th:each="rate : ${allTaxRates}" class="form-check">
                <input class="form-check-input" type="checkbox" name="availableTaxRates" th:value="${rate.id}" th:id="'taxRate_' + ${rate.id}"
                       th:checked="${#sets.contains(product.availableTaxRates, rate)}">
                <label class="form-check-label" th:for="'taxRate_' + ${rate.id}" th:text="${rate.name + ' (' + #numbers.formatDecimal(rate.rate * 100, 0, 'POINT', 0, 'COMMA') + ' %)'}"></label>
            </div>
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('availableTaxRates')}" th:errors="*{availableTaxRates}"></div>
            <th:block th:if="${#fields.hasGlobalErrors()}">
                <div class="text-danger small mt-1" th:each="err : ${#fields.globalErrors()}" th:if="${#strings.containsIgnoreCase(err, 'tax rate')}" th:text="${err}"></div>
            </th:block>
        </div>

        <hr>
        <h4>Konfigurátor produktu na míru</h4>
        <th:block th:if="${product.configurator != null}">
            <div id="configuratorSettings">
                <h5>Rozměry (v cm) - zadejte rozmezí, výchozí hodnoty a krok</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.minLength" class="form-label">Min. Délka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.minLength" th:field="*{configurator.minLength}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.minLength')}" th:errors="*{configurator.minLength}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.maxLength" class="form-label">Max. Délka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.maxLength" th:field="*{configurator.maxLength}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.maxLength')}" th:errors="*{configurator.maxLength}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.defaultLength" class="form-label">Výchozí Délka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.defaultLength" th:field="*{configurator.defaultLength}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.defaultLength')}" th:errors="*{configurator.defaultLength}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.stepLength" class="form-label">Krok Délky:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.stepLength" th:field="*{configurator.stepLength}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.stepLength')}" th:errors="*{configurator.stepLength}"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.minWidth" class="form-label">Min. Šířka/Hloubka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.minWidth" th:field="*{configurator.minWidth}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.minWidth')}" th:errors="*{configurator.minWidth}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.maxWidth" class="form-label">Max. Šířka/Hloubka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.maxWidth" th:field="*{configurator.maxWidth}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.maxWidth')}" th:errors="*{configurator.maxWidth}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.defaultWidth" class="form-label">Výchozí Šířka/Hloubka:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.defaultWidth" th:field="*{configurator.defaultWidth}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.defaultWidth')}" th:errors="*{configurator.defaultWidth}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.stepWidth" class="form-label">Krok Šířky/Hloubky:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.stepWidth" th:field="*{configurator.stepWidth}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.stepWidth')}" th:errors="*{configurator.stepWidth}"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.minHeight" class="form-label">Min. výška:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.minHeight" th:field="*{configurator.minHeight}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.minHeight')}" th:errors="*{configurator.minHeight}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.maxHeight" class="form-label">Max. výška:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.maxHeight" th:field="*{configurator.maxHeight}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.maxHeight')}" th:errors="*{configurator.maxHeight}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.defaultHeight" class="form-label">Výchozí výška:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.defaultHeight" th:field="*{configurator.defaultHeight}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.defaultHeight')}" th:errors="*{configurator.defaultHeight}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.stepHeight" class="form-label">Krok výšky:</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.stepHeight" th:field="*{configurator.stepHeight}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.stepHeight')}" th:errors="*{configurator.stepHeight}"></div>
                    </div>
                </div>
                <p class="form-text text-muted">
                    Zadejte limity, výchozí hodnoty a krok pro každý rozměr. Výchozí hodnota a krok musí být v rámci min/max limitů.
                </p>

                <h5>Ceny za rozměry (bez DPH)</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmLengthCZK" class="form-label">Cena/cm délky (CZK):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmLengthCZK" th:field="*{configurator.pricePerCmLengthCZK}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmLengthCZK')}" th:errors="*{configurator.pricePerCmLengthCZK}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmWidthCZK" class="form-label">Cena/cm Šířky/Hloubky (CZK):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmWidthCZK" th:field="*{configurator.pricePerCmWidthCZK}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmWidthCZK')}" th:errors="*{configurator.pricePerCmWidthCZK}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmHeightCZK" class="form-label">Cena/cm výšky (CZK):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmHeightCZK" th:field="*{configurator.pricePerCmHeightCZK}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmHeightCZK')}" th:errors="*{configurator.pricePerCmHeightCZK}"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmLengthEUR" class="form-label">Cena/cm délky (EUR):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmLengthEUR" th:field="*{configurator.pricePerCmLengthEUR}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmLengthEUR')}" th:errors="*{configurator.pricePerCmLengthEUR}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmWidthEUR" class="form-label">Cena/cm Šířky/Hloubky (EUR):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmWidthEUR" th:field="*{configurator.pricePerCmWidthEUR}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmWidthEUR')}" th:errors="*{configurator.pricePerCmWidthEUR}"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="configurator.pricePerCmHeightEUR" class="form-label">Cena/cm výšky (EUR):</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="configurator.pricePerCmHeightEUR" th:field="*{configurator.pricePerCmHeightEUR}">
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('configurator.pricePerCmHeightEUR')}" th:errors="*{configurator.pricePerCmHeightEUR}"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Dostupné doplňky pro konfiguraci na míru:</label>
                    <p class="form-text text-muted">Zaškrtněte doplňky, které si zákazník bude moci k tomuto produktu přidat. Ceny doplňků se nastavují v sekci Doplňky.</p>
                    <div th:if="${allAddons == null or #lists.isEmpty(allAddons)}" class="alert alert-light alert-sm">
                        Nebyly nalezeny žádné aktivní doplňky. Můžete je vytvořit v sekci <a th:href="@{/admin/addons}">Doplňky</a>.
                    </div>
                    <div th:each="addon : ${allAddons}" class="form-check">
                        <input class="form-check-input" type="checkbox" name="availableAddons" th:value="${addon.id}" th:id="'addon_' + ${addon.id}"
                               th:checked="${#sets.contains(product.availableAddons, addon)}">
                        <label class="form-check-label" th:for="'addon_' + ${addon.id}" th:text="${addon.name + ' (' + (addon.priceCZK != null ? #numbers.formatDecimal(addon.priceCZK, 1, 'POINT', 2, 'COMMA') + ' Kč' : 'N/A') + ' / ' + (addon.priceEUR != null ? #numbers.formatDecimal(addon.priceEUR, 1, 'POINT', 2, 'COMMA') + ' €' : 'N/A') + ')'}"></label>
                    </div>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('availableAddons')}" th:errors="*{availableAddons}"></div>
                </div>
            </div>
        </th:block>

        <div th:if="${product.configurator == null}" class="alert alert-warning mt-3">
            Konfigurátor pro tento produkt nebyl nalezen nebo inicializován. Zkontrolujte data produktu nebo kontaktujte administrátora.
        </div>

        <hr>
        <h4>SEO</h4>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="metaTitle" class="form-label">Meta Title:</label>
                <input type="text" class="form-control" id="metaTitle" th:field="*{metaTitle}">
                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('metaTitle')}" th:errors="*{metaTitle}"></div>
            </div>
            <div class="col-md-6">
                <label for="metaDescription" class="form-label">Meta Description:</label>
                <textarea class="form-control" id="metaDescription" th:field="*{metaDescription}" rows="2"></textarea>
                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('metaDescription')}" th:errors="*{metaDescription}"></div>
            </div>
        </div>

        <hr>
        <h4>Obrázky produktu</h4>
        <div class="mb-3 border p-3 rounded">
            <label class="form-label d-block">Aktuální obrázky:</label>
            <div id="imageMessages"> <div th:if="${imageError}" class="alert alert-danger alert-sm mt-2" role="alert" th:text="${imageError}"></div>
                <div th:if="${imageSuccess}" class="alert alert-success alert-sm mt-2" role="alert" th:text="${imageSuccess}"></div>
            </div>

            <div id="currentImages">
                <div th:if="${#lists.isEmpty(product.images)}" class="text-muted mb-2" id="noImagesText">Žádné obrázky nebyly nahrány.</div>
                <div th:each="image : ${product.images}" class="image-preview d-flex align-items-center mb-2 border-bottom pb-2" th:id="'image-preview-' + ${image.id}">
                    <img th:src="@{${image.url}}" th:alt="${image.altText ?: 'Náhled'}" style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px;">
                    <div class="flex-grow-1">
                        <input type="number" class="form-control form-control-sm mb-1 image-order-input" th:value="${image.displayOrder}" min="0" placeholder="Pořadí" th:data-image-id="${image.id}">
                        <small th:text="${image.url}"></small>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm ms-2 delete-image-btn" title="Smazat obrázek" th:data-image-id="${image.id}" th:data-product-id="${product.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <button type="button" id="updateImageOrderBtn" class="btn btn-outline-secondary btn-sm mt-2" th:styleappend="${#lists.isEmpty(product.images)} ? 'display: none;' : ''" th:if="${product.id != null}">Aktualizovat pořadí</button>


            <div class="mt-3 pt-3 border-top" th:if="${product.id != null}">
                <h5>Nahrát nový obrázek</h5>
                <div class="mb-2">
                    <label for="newImageFile" class="form-label">Soubor:</label>
                    <input type="file" class="form-control form-control-sm" id="newImageFile" name="imageFile" accept="image/png, image/jpeg, image/webp, image/gif">
                </div>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label for="newAltText" class="form-label">Alt text:</label>
                        <input type="text" class="form-control form-control-sm" id="newAltText" name="altText">
                    </div>
                    <div class="col-md-4">
                        <label for="newTitleText" class="form-label">Title text:</label>
                        <input type="text" class="form-control form-control-sm" id="newTitleText" name="titleText">
                    </div>
                    <div class="col-md-4">
                        <label for="newDisplayOrder" class="form-label">Pořadí:</label>
                        <input type="number" class="form-control form-control-sm" id="newDisplayOrder" name="displayOrder" placeholder="Auto">
                    </div>
                </div>
                <button type="button" id="uploadImageBtnAjax" class="btn btn-success btn-sm mt-2">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                    <i class="bi bi-upload"></i> Nahrát obrázek
                </button>
            </div>
        </div> <hr>
        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> [[${product.id == null ? 'Vytvořit produkt' : 'Uložit změny'}]]</button>
        <a th:href="@{/admin/products}" class="btn btn-secondary">Zrušit</a>

    </form> </div><script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {

        // --- CSRF a Zprávy ---
        const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");
        const imageMessagesDiv = document.getElementById('imageMessages');
        const currentImagesDiv = document.getElementById('currentImages');
        const noImagesTextDiv = document.getElementById('noImagesText'); // Div se zprávou "Žádné obrázky"
        const updateOrderButton = document.getElementById('updateImageOrderBtn');
        const productId = document.querySelector('#productFormCustom input[name="id"]')?.value; // Získání ID produktu

        function showImageMessage(message, isSuccess = true) {
            // ... (kód pro showImageMessage zůstává stejný jako v předchozí odpovědi) ...
            if (!imageMessagesDiv) return;
            const alertClass = isSuccess ? 'alert-success' : 'alert-danger';
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert ${alertClass} alert-sm mt-2`;
            messageDiv.setAttribute('role', 'alert');
            messageDiv.textContent = message;
            imageMessagesDiv.innerHTML = ''; // Vymaže předchozí
            imageMessagesDiv.appendChild(messageDiv);
            setTimeout(() => { messageDiv.remove(); }, 5000); // Skryje po 5s
        }

        // Funkce pro vytvoření HTML náhledu obrázku
        function createImagePreviewHTML(image) {
            const imageId = image.id;
            const imageUrl = /*[[@{/}]]*/ '/' + image.url; // Předpokládá, že URL je relativní cesta
            const altText = image.altText || 'Náhled';
            const displayOrder = image.displayOrder || 0;

            // Bezpečnostní kontrola - escapování HTML, pokud by texty mohly obsahovat škodlivý kód
            // Pro jednoduchost zde neimplementováno, ale v produkci zvážit!

            return `
            <div class="image-preview d-flex align-items-center mb-2 border-bottom pb-2" id="image-preview-${imageId}">
                <img src="${imageUrl}" alt="${altText}" style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px;">
                <div class="flex-grow-1">
                    <input type="number" class="form-control form-control-sm mb-1 image-order-input" value="${displayOrder}" min="0" placeholder="Pořadí" data-image-id="${imageId}">
                    <small>${image.url}</small>
                </div>
                <button type="button" class="btn btn-danger btn-sm ms-2 delete-image-btn" title="Smazat obrázek" data-image-id="${imageId}" data-product-id="${productId}">
                    <i class="bi bi-trash"></i>
                </button>
            </div>`;
        }


        // ---- Kontrola stavu na začátku ----
        function checkImagesState() {
            const hasImages = currentImagesDiv.querySelector('.image-preview') !== null;
            if (noImagesTextDiv) {
                noImagesTextDiv.style.display = hasImages ? 'none' : 'block';
            }
            if (updateOrderButton) {
                updateOrderButton.style.display = hasImages ? 'inline-block' : 'none';
            }
        }
        checkImagesState(); // Spustí kontrolu při načtení stránky


        // ---- Obsluha smazání obrázku (zůstává stejná) ----
        currentImagesDiv.addEventListener('click', function(event) {
            const deleteButton = event.target.closest('.delete-image-btn');
            if (deleteButton) {
                event.preventDefault();
                const imageId = deleteButton.dataset.imageId;
                // const productId = deleteButton.dataset.productId; // productId máme globálně
                const imagePreviewDiv = document.getElementById(`image-preview-${imageId}`);

                if (!imageId || !productId) {
                    showImageMessage('Chyba: Nelze identifikovat obrázek/produkt pro smazání.', false); return;
                }

                if (confirm('Opravdu smazat tento obrázek?')) {
                    const url = /*[[@{/admin/products/images/}]]*/ '/admin/products/images/' + imageId + '/delete';
                    fetch(url, { method: 'POST', headers: { 'Accept': 'application/json', [csrfHeader]: csrfToken } })
                        .then(response => {
                            if (response.ok) {
                                if(imagePreviewDiv) { imagePreviewDiv.remove(); }
                                showImageMessage('Obrázek byl úspěšně smazán.', true);
                                checkImagesState(); // Aktualizuje zobrazení "Žádné obrázky" / tlačítka
                            } else {
                                response.text().then(text => showImageMessage(`Smazání selhalo: ${response.statusText} ${text ? '('+text+')' : ''}`, false));
                            }
                        })
                        .catch(error => showImageMessage('Chyba sítě při mazání: ' + error.message, false));
                }
            }
        });

        // ---- Obsluha aktualizace pořadí (zůstává stejná) ----
        if (updateOrderButton) {
            updateOrderButton.addEventListener('click', function(event) {
                event.preventDefault();
                if (!productId) {
                    showImageMessage('Chyba: Nelze identifikovat produkt pro aktualizaci pořadí.', false); return;
                }

                const imageOrderInputs = document.querySelectorAll('.image-order-input');
                const imageOrderData = {};
                imageOrderInputs.forEach(input => {
                    const imageId = input.dataset.imageId;
                    if (imageId) {
                        const orderValue = parseInt(input.value, 10);
                        imageOrderData[imageId] = isNaN(orderValue) ? 0 : orderValue;
                    }
                });

                if (Object.keys(imageOrderData).length === 0) {
                    showImageMessage('Nebyly nalezeny žádné obrázky k aktualizaci.', false); return;
                }

                const url = /*[[@{/admin/products/images/update-order}]]*/ '/admin/products/images/update-order';
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', [csrfHeader]: csrfToken },
                    body: JSON.stringify({ productId: productId, orderMap: imageOrderData })
                })
                    .then(response => {
                        if (response.ok) {
                            showImageMessage('Pořadí obrázků bylo úspěšně aktualizováno.', true);
                        } else {
                            response.text().then(text => showImageMessage(`Aktualizace pořadí selhala: ${response.statusText} ${text ? '('+text+')' : ''}`, false));
                        }
                    })
                    .catch(error => showImageMessage('Chyba sítě při aktualizaci pořadí: ' + error.message, false));
            });
        }

        // ---- NOVÁ Obsluha AJAX nahrání obrázku ----
        const uploadButton = document.getElementById('uploadImageBtnAjax');
        const fileInput = document.getElementById('newImageFile');
        const altTextInput = document.getElementById('newAltText');
        const titleTextInput = document.getElementById('newTitleText');
        const displayOrderInput = document.getElementById('newDisplayOrder');
        const uploadSpinner = uploadButton?.querySelector('.spinner-border');

        if (uploadButton && fileInput && productId) { // Funguje jen při editaci (productId existuje)
            uploadButton.addEventListener('click', function() {
                const file = fileInput.files[0];
                if (!file) {
                    showImageMessage('Nebyl vybrán žádný soubor k nahrání.', false);
                    return;
                }

                // Validace velikosti / typu souboru (nepovinné, ale doporučené)
                /*
                if (file.size > MAX_FILE_SIZE) { ... }
                if (!ALLOWED_MIME_TYPES.includes(file.type)) { ... }
                */

                const formData = new FormData();
                formData.append('imageFile', file); // Název musí odpovídat @RequestParam v kontroleru
                formData.append('altText', altTextInput.value);
                formData.append('titleText', titleTextInput.value);
                formData.append('displayOrder', displayOrderInput.value); // Posíláme i prázdné, server si poradí

                const url = /*[[@{/admin/products/}]]*/ '/admin/products/' + productId + '/images/upload';

                // Zobraz spinner a deaktivuj tlačítko
                if (uploadSpinner) uploadSpinner.style.display = 'inline-block';
                uploadButton.disabled = true;
                showImageMessage('Nahrávám obrázek...', true); // Použijeme success styl jako indikátor procesu

                fetch(url, {
                    method: 'POST',
                    headers: {
                        // DŮLEŽITÉ: NEPOSÍLAT 'Content-Type' manuálně pro FormData!
                        'Accept': 'application/json', // Očekáváme JSON odpověď
                        [csrfHeader]: csrfToken
                    },
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json(); // Očekáváme JSON s daty nahraného obrázku
                        } else {
                            // Vytvoříme Promise reject, aby to šlo do .catch()
                            return response.text().then(text => Promise.reject(new Error(`Chyba ${response.status}: ${response.statusText} ${text ? '('+text+')' : ''}`)));
                        }
                    })
                    .then(savedImageData => { // Data úspěšně nahraného obrázku
                        console.log('Obrázek úspěšně nahrán:', savedImageData);
                        // Vytvoř HTML pro nový obrázek a přidej ho
                        const newImageHTML = createImagePreviewHTML(savedImageData);
                        // Odeber zprávu "Žádné obrázky", pokud tam je
                        const noImagesDiv = document.getElementById('noImagesText');
                        if (noImagesDiv) noImagesDiv.style.display = 'none';
                        // Přidej nový obrázek
                        currentImagesDiv.insertAdjacentHTML('beforeend', newImageHTML);

                        // Vyčisti formulářová pole pro upload
                        fileInput.value = '';
                        altTextInput.value = '';
                        titleTextInput.value = '';
                        displayOrderInput.value = '';

                        showImageMessage('Obrázek byl úspěšně nahrán.', true);
                        checkImagesState(); // Zobrazí tlačítko pro aktualizaci pořadí

                    })
                    .catch(error => {
                        console.error('Chyba při nahrávání obrázku:', error);
                        showImageMessage(error.message || 'Nahrání obrázku selhalo.', false);
                    })
                    .finally(() => {
                        // Skryj spinner a znovu aktivuj tlačítko
                        if (uploadSpinner) uploadSpinner.style.display = 'none';
                        uploadButton.disabled = false;
                    });
            });
        }

        // --- Logování hlavního formuláře (pro kontrolu) ---
        const theForm = document.getElementById('productFormCustom');
        if (theForm) {
            console.log('[LOG] Hlavní formulář (#productFormCustom) nalezen a měl by být funkční.');
            theForm.addEventListener('submit', function(event) {
                console.log('[LOG] HLAVNÍ FORM SUBMIT EVENT TRIGGERED! Odesílám na:', theForm.action);
                // Můžeš přidat spinner nebo deaktivaci tlačítka i zde
            });
        } else {
            console.error('[ERROR] Nepodařilo se najít hlavní formulář (#productFormCustom)!');
        }

    });
    /*]]>*/
</script>

</body>
</html>