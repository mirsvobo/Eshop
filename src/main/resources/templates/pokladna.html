<!DOCTYPE html>
<html lang="cs" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE">Pokladna - Dřevníky Kolář</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" type="text/css" th:href="@{/css/custom.css}"/>
        <style>
            .invalid-feedback.d-block {
                display: block !important;
            }

            /* Volitelně: Mírné odsazení pro scroll, aby pole nebylo úplně u horního okraje */
            .is-invalid:focus {
                /* scroll-margin-top: 80px; /* Experimentuj s hodnotou */
            }
        </style>
    </th:block>
</head>
<body>

<section layout:fragment="content">
    <div class="container mt-5 mb-5">
        <h1>Dokončení objednávky</h1>
        <hr class="mb-4">

        <div th:if="${checkoutError}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong th:text="${checkoutError}">Chyba při zpracování objednávky.</strong>
            <th:block th:if="${checkoutErrorDetail}"><br/><small th:text="${checkoutErrorDetail}"></small></th:block>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div id="shipping-error-alert" class="alert alert-warning alert-dismissible fade show d-none" role="alert">
            <span id="shipping-error-text">Chyba výpočtu dopravy.</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div id="form-validation-errors-summary" th:if="${#fields.hasErrors('checkoutForm.*')}"
             class="alert alert-danger" role="alert">
            Prosím, zkontrolujte a opravte chyby ve formuláři zvýrazněné červeně.
        </div>

        <form th:action="@{/pokladna/odeslat}" th:object="${checkoutForm}" method="post" id="checkout-form" novalidate
              th:data-is-user-logged-in="${customer != null}"
              th:data-csrf-token="${_csrf?.token}"
              th:data-csrf-header-name="${_csrf?.headerName}"
              th:data-calculate-shipping-url="@{/pokladna/calculate-shipping}"
              th:data-currency-symbol="${currencySymbol}"
              th:data-initial-shipping-valid="${totalPrice != null && shippingError == null}"
              th:data-initial-cart-empty="${cart == null or not cart.hasItems()}"
              th:data-initial-total-item-vat="${totalVat != null ? #numbers.formatDecimal(totalVat, 1, 'NONE', 2, 'POINT') : '0'}"
              th:data-initial-subtotal="${subtotal != null ? #numbers.formatDecimal(subtotal, 1, 'NONE', 2, 'POINT') : '0'}"
              th:data-initial-coupon-discount="${couponDiscount != null ? #numbers.formatDecimal(couponDiscount, 1, 'NONE', 2, 'POINT') : '0'}"
        >
            <input type="hidden" id="hiddenShippingCostNoTax" name="shippingCostNoTax"
                   th:value="${originalShippingCostNoTax != null ? #numbers.formatDecimal(originalShippingCostNoTax, 1, 'NONE', 2, 'POINT') : ''}">
            <input type="hidden" id="hiddenShippingTax" name="shippingTax"
                   th:value="${shippingTax != null ? #numbers.formatDecimal(shippingTax, 1, 'NONE', 2, 'POINT') : ''}">

            <div class="row g-5">

                <div class="col-lg-7">
                    <h4>Kontaktní a fakturační údaje</h4>

                    <div th:unless="${customer != null}" class="guest-info">
                        <div class="mb-3">
                            <label for="email" class="form-label">E-mail <span class="text-danger">*</span></label>
                            <input type="email" class="form-control"
                                   th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'" id="email"
                                   th:field="*{email}" required>
                            <div th:if="${#fields.hasErrors('email')}" class="invalid-feedback d-block"><span
                                    th:errors="*{email}">Chyba emailu</span></div>
                        </div>
                        <p class="text-muted">Máte účet? <a th:href="@{/prihlaseni(redirectUrl='/pokladna')}">Přihlaste
                            se</a> pro rychlejší vyplnění.</p>
                    </div>
                    <div th:if="${customer != null}" class="registered-user-info">
                        <p><strong>Přihlášen jako:</strong> <span th:text="${customer.email}"></span></p>
                        <input type="hidden" th:field="*{email}"/>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">Jméno <span class="text-danger">*</span></label>
                            <input type="text" class="form-control"
                                   th:classappend="${#fields.hasErrors('firstName')} ? 'is-invalid'" id="firstName"
                                   th:field="*{firstName}" required>
                            <div th:if="${#fields.hasErrors('firstName')}" class="invalid-feedback d-block"><span
                                    th:errors="*{firstName}">Chyba jména</span></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Příjmení <span class="text-danger">*</span></label>
                            <input type="text" class="form-control"
                                   th:classappend="${#fields.hasErrors('lastName')} ? 'is-invalid'" id="lastName"
                                   th:field="*{lastName}" required>
                            <div th:if="${#fields.hasErrors('lastName')}" class="invalid-feedback d-block"><span
                                    th:errors="*{lastName}">Chyba příjmení</span></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="phonePrefix" class="form-label">Telefon <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <select class="form-select" id="phonePrefix" name="phonePrefix" style="max-width: 100px;"
                                    aria-label="Předvolba"
                                    th:classappend="${#fields.hasErrors('phone')} ? 'is-invalid'">
                                <option value="+420"
                                        th:selected="*{phone == null or #strings.startsWith(phone, '+420')}">+420
                                </option>
                                <option value="+421"
                                        th:selected="*{phone != null and #strings.startsWith(phone, '+421')}">+421
                                </option>
                            </select>
                            <input type="tel" class="form-control" id="phoneNumberPart"
                                   th:classappend="${#fields.hasErrors('phone')} ? 'is-invalid'"
                                   placeholder="Zadejte číslo bez předvolby" required
                                   th:value="*{phone != null ? #strings.substringAfter(phone, #strings.startsWith(phone, '+420') ? '+420' : (#strings.startsWith(phone, '+421') ? '+421' : '')) : ''}"
                                   pattern="[0-9\s]{9,15}">
                        </div>
                        <input type="hidden" id="phone" th:field="*{phone}">
                        <div th:if="${#fields.hasErrors('phone')}" class="invalid-feedback d-block">
                            <span th:errors="*{phone}">Chyba telefonu</span>
                        </div>
                    </div>

                    <hr>
                    <h5>Fakturační adresa</h5>

                    <div class="mb-3">
                        <label for="invoiceCompanyName" class="form-label">Název firmy (volitelné)</label>
                        <input type="text" class="form-control"
                               th:classappend="${#fields.hasErrors('invoiceCompanyName')} ? 'is-invalid'"
                               id="invoiceCompanyName" th:field="*{invoiceCompanyName}">
                        <div th:if="${#fields.hasErrors('invoiceCompanyName')}" class="invalid-feedback d-block"><span
                                th:errors="*{invoiceCompanyName}">Chyba názvu firmy</span></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="invoiceTaxId" class="form-label">IČO</label>
                            <input type="text" class="form-control"
                                   th:classappend="${#fields.hasErrors('invoiceTaxId')} ? 'is-invalid'"
                                   id="invoiceTaxId" th:field="*{invoiceTaxId}">
                            <div th:if="${#fields.hasErrors('invoiceTaxId')}" class="invalid-feedback d-block">
                                <span th:errors="*{invoiceTaxId}">Chyba IČO</span>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="invoiceVatId" class="form-label">DIČ</label>
                            <input type="text" class="form-control"
                                   th:classappend="${#fields.hasErrors('invoiceVatId')} ? 'is-invalid'"
                                   id="invoiceVatId" th:field="*{invoiceVatId}">
                            <div th:if="${#fields.hasErrors('invoiceVatId')}" class="invalid-feedback d-block">
                                <span th:errors="*{invoiceVatId}">Chyba DIČ</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="invoiceStreet" class="form-label">Ulice a č.p./č.o. <span
                                class="text-danger">*</span></label>
                        <input type="text" class="form-control address-trigger"
                               th:classappend="${#fields.hasErrors('invoiceStreet')} ? 'is-invalid'" id="invoiceStreet"
                               th:field="*{invoiceStreet}" required>
                        <div th:if="${#fields.hasErrors('invoiceStreet')}" class="invalid-feedback d-block"><span
                                th:errors="*{invoiceStreet}">Chyba ulice</span></div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="invoiceCity" class="form-label">Město <span class="text-danger">*</span></label>
                            <input type="text" class="form-control address-trigger"
                                   th:classappend="${#fields.hasErrors('invoiceCity')} ? 'is-invalid'" id="invoiceCity"
                                   th:field="*{invoiceCity}" required>
                            <div th:if="${#fields.hasErrors('invoiceCity')}" class="invalid-feedback d-block"><span
                                    th:errors="*{invoiceCity}">Chyba města</span></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="invoiceZipCode" class="form-label">PSČ <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control address-trigger"
                                   th:classappend="${#fields.hasErrors('invoiceZipCode')} ? 'is-invalid'"
                                   id="invoiceZipCode" th:field="*{invoiceZipCode}" required>
                            <div th:if="${#fields.hasErrors('invoiceZipCode')}" class="invalid-feedback d-block"><span
                                    th:errors="*{invoiceZipCode}">Chyba PSČ</span></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="invoiceCountry" class="form-label">Země <span class="text-danger">*</span></label>
                        <input type="text" class="form-control address-trigger"
                               th:classappend="${#fields.hasErrors('invoiceCountry')} ? 'is-invalid'"
                               id="invoiceCountry" th:field="*{invoiceCountry}" required>
                        <div th:if="${#fields.hasErrors('invoiceCountry')}" class="invalid-feedback d-block"><span
                                th:errors="*{invoiceCountry}">Chyba země</span></div>
                    </div>

                    <h5>Režim DPH</h5>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="applyReverseCharge"
                               th:field="*{applyReverseCharge}"
                               th:classappend="${#fields.hasErrors('applyReverseCharge')} ? 'is-invalid'">
                        <label class="form-check-label" for="applyReverseCharge">
                            Uplatnit přenesenou daňovou povinnost (pro plátce DPH dle § 92a)
                        </label>
                        <div class="form-text">Zaškrtněte pouze v případě, že jste plátce DPH a objednáváte stavební
                            práce.
                        </div>
                        <div th:if="${#fields.hasErrors('applyReverseCharge')}" class="invalid-feedback d-block"><span
                                th:errors="*{applyReverseCharge}">Chyba</span></div>
                    </div>

                    <hr>
                    <div class="form-check mb-3">
                        <input class="form-check-input address-trigger" type="checkbox" id="useInvoiceAddressAsDelivery"
                               th:field="*{useInvoiceAddressAsDelivery}"
                               th:classappend="${#fields.hasErrors('useInvoiceAddressAsDelivery')} ? 'is-invalid'">
                        <label class="form-check-label" for="useInvoiceAddressAsDelivery">
                            Dodací adresa je stejná jako fakturační
                        </label>
                        <div th:if="${#fields.hasErrors('useInvoiceAddressAsDelivery')}"
                             class="invalid-feedback d-block"><span
                                th:errors="*{useInvoiceAddressAsDelivery}">Chyba</span></div>
                    </div>

                    <div class="delivery-address-fields"
                         th:classappend="*{useInvoiceAddressAsDelivery} ? 'hidden' : ''">
                        <h5>Dodací adresa</h5>
                        <div class="mb-3">
                            <label for="deliveryCompanyName" class="form-label">Název firmy (volitelné)</label>
                            <input type="text" class="form-control address-trigger"
                                   th:classappend="${#fields.hasErrors('deliveryCompanyName')} ? 'is-invalid'"
                                   id="deliveryCompanyName" th:field="*{deliveryCompanyName}">
                            <div th:if="${#fields.hasErrors('deliveryCompanyName')}" class="invalid-feedback d-block">
                                <span th:errors="*{deliveryCompanyName}">Chyba názvu firmy</span></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="deliveryFirstName" class="form-label">Jméno <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control address-trigger"
                                       th:classappend="${#fields.hasErrors('deliveryFirstName')} ? 'is-invalid'"
                                       id="deliveryFirstName" th:field="*{deliveryFirstName}">
                                <div th:if="${#fields.hasErrors('deliveryFirstName')}" class="invalid-feedback d-block">
                                    <span th:errors="*{deliveryFirstName}">Chyba jména</span></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="deliveryLastName" class="form-label">Příjmení <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control address-trigger"
                                       th:classappend="${#fields.hasErrors('deliveryLastName')} ? 'is-invalid'"
                                       id="deliveryLastName" th:field="*{deliveryLastName}">
                                <div th:if="${#fields.hasErrors('deliveryLastName')}" class="invalid-feedback d-block">
                                    <span th:errors="*{deliveryLastName}">Chyba příjmení</span></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="deliveryStreet" class="form-label">Ulice a č.p./č.o. <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control address-trigger"
                                   th:classappend="${#fields.hasErrors('deliveryStreet')} ? 'is-invalid'"
                                   id="deliveryStreet" th:field="*{deliveryStreet}">
                            <div th:if="${#fields.hasErrors('deliveryStreet')}" class="invalid-feedback d-block"><span
                                    th:errors="*{deliveryStreet}">Chyba ulice</span></div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="deliveryCity" class="form-label">Město <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control address-trigger"
                                       th:classappend="${#fields.hasErrors('deliveryCity')} ? 'is-invalid'"
                                       id="deliveryCity" th:field="*{deliveryCity}">
                                <div th:if="${#fields.hasErrors('deliveryCity')}" class="invalid-feedback d-block"><span
                                        th:errors="*{deliveryCity}">Chyba města</span></div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="deliveryZipCode" class="form-label">PSČ <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control address-trigger"
                                       th:classappend="${#fields.hasErrors('deliveryZipCode')} ? 'is-invalid'"
                                       id="deliveryZipCode" th:field="*{deliveryZipCode}">
                                <div th:if="${#fields.hasErrors('deliveryZipCode')}" class="invalid-feedback d-block">
                                    <span th:errors="*{deliveryZipCode}">Chyba PSČ</span></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="deliveryCountry" class="form-label">Země <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control address-trigger"
                                   th:classappend="${#fields.hasErrors('deliveryCountry')} ? 'is-invalid'"
                                   id="deliveryCountry" th:field="*{deliveryCountry}">
                            <div th:if="${#fields.hasErrors('deliveryCountry')}" class="invalid-feedback d-block"><span
                                    th:errors="*{deliveryCountry}">Chyba země</span></div>
                        </div>
                        <div class="mb-3">
                            <label for="deliveryPhonePrefix" class="form-label">Telefon (pro dopravce) <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <select class="form-select" id="deliveryPhonePrefix" name="deliveryPhonePrefix"
                                        style="max-width: 100px;" aria-label="Předvolba dodací"
                                        th:classappend="${#fields.hasErrors('deliveryPhone')} ? 'is-invalid'">
                                    <option value="+420"
                                            th:selected="*{deliveryPhone == null or #strings.startsWith(deliveryPhone, '+420')}">
                                        +420
                                    </option>
                                    <option value="+421"
                                            th:selected="*{deliveryPhone != null and #strings.startsWith(deliveryPhone, '+421')}">
                                        +421
                                    </option>
                                </select>
                                <input type="tel" class="form-control address-trigger" id="deliveryPhoneNumberPart"
                                       th:classappend="${#fields.hasErrors('deliveryPhone')} ? 'is-invalid'"
                                       placeholder="Zadejte číslo bez předvolby"
                                       th:value="*{deliveryPhone != null ? #strings.substringAfter(deliveryPhone, #strings.startsWith(deliveryPhone, '+420') ? '+420' : (#strings.startsWith(deliveryPhone, '+421') ? '+421' : '')) : ''}"
                                       pattern="[0-9\s]{9,15}">
                            </div>
                            <input type="hidden" id="deliveryPhone" th:field="*{deliveryPhone}">
                            <div th:if="${#fields.hasErrors('deliveryPhone')}" class="invalid-feedback d-block">
                                <span th:errors="*{deliveryPhone}">Chyba dodacího telefonu</span>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <h4>Doprava a platba</h4>
                    <div class="mb-3">
                        <label class="form-label">Doprava</label>
                        <div class="input-group">
                            <span class="input-group-text" style="min-width: 150px;">Doprava Kolář</span>
                            <span class="form-control text-end" id="shipping-cost-display">
                                 <span id="shipping-cost-value">
                                     <span th:if="${originalShippingCostNoTax != null}"
                                           th:text="${#numbers.formatDecimal(originalShippingCostNoTax, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currencySymbol} + ' (bez DPH)'"></span>
                                 </span>
                                 <span id="shipping-cost-error" class="text-warning recalculate-shipping-notice">
                                     <span th:if="${shippingError != null}" th:text="${shippingError}"></span>
                                 </span>
                                 <span class="spinner-border spinner-border-sm text-primary ms-2 align-middle d-none"
                                       role="status" aria-hidden="true"></span>
                             </span>
                            <button class="btn btn-outline-secondary" type="button" id="calculate-shipping-btn">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Spočítat dopravu dle adresy
                            </button>
                        </div>
                        <div class="form-text">Cena dopravy se vypočítá na základě vaší dodací adresy. Po změně adresy
                            je nutné cenu přepočítat.
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Způsob platby <span class="text-danger">*</span></label>
                        <div th:each="method : ${allowedPaymentMethods}">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" th:id="'paymentMethod_' + ${method.key}"
                                       th:field="*{paymentMethod}" th:value="${method.key}" required
                                       th:classappend="${#fields.hasErrors('paymentMethod')} ? 'is-invalid'">
                                <label class="form-check-label" th:for="'paymentMethod_' + ${method.key}"
                                       th:text="${method.value}"></label>
                            </div>
                        </div>
                        <div th:if="${#fields.hasErrors('paymentMethod')}" class="invalid-feedback d-block"><span
                                th:errors="*{paymentMethod}">Vyberte způsob platby</span></div>
                    </div>

                    <div class="mb-3">
                        <label for="customerNote" class="form-label">Poznámka k objednávce (volitelné)</label>
                        <textarea class="form-control" id="customerNote" th:field="*{customerNote}" rows="3"
                                  th:classappend="${#fields.hasErrors('customerNote')} ? 'is-invalid'"></textarea>
                        <div th:if="${#fields.hasErrors('customerNote')}" class="invalid-feedback d-block"><span
                                th:errors="*{customerNote}">Chyba poznámky</span></div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card shadow-sm sticky-top order-summary-card" style="top: 76px;">
                        <div class="card-header bg-light">
                            <h4 class="my-1 fw-medium">Souhrn objednávky</h4>
                        </div>
                        <div class="card-body p-4 summary-card-body">
                            <h6 class="mb-3 text-muted">Položky v košíku</h6>
                            <ul class="list-group list-group-flush mb-4" th:if="${cart != null and cart.hasItems()}">
                                <li th:each="item : ${cart.itemsList}"
                                    class="list-group-item d-flex justify-content-between align-items-start px-0">
                                    <div class="me-2">
                                        <div class="fw-medium"
                                             th:text="${item.quantity} + 'x ' + ${item.productName}"></div>
                                        <small class="text-muted d-block item-description-details"
                                               th:utext="${#strings.replace(item.variantInfo,'|','<br/>')} ?: ''"></small>
                                        <div th:if="${item.selectedAddons != null and not #lists.isEmpty(item.selectedAddons)}"
                                             class="text-muted d-block mt-1 item-description-details">
                                            <small>+ <span th:each="addon, iter : ${item.selectedAddons}"
                                                           th:text="${addon.addonName} + (${!iter.last} ? ', ' : '')"></span></small>
                                        </div>
                                    </div>
                                    <span class="text-nowrap"
                                          th:text="${#numbers.formatDecimal(item.getTotalLinePriceWithoutTax(currentCurrency), 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currencySymbol}"></span>
                                </li>
                            </ul>
                            <p th:unless="${cart != null and cart.hasItems()}">Košík je prázdný.</p>

                            <h6 class="mb-3 text-muted">Cenový souhrn</h6>
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item d-flex justify-content-between px-0">
                                    <span class="summary-label">Položky celkem (bez DPH)</span>
                                    <span class="summary-value" id="summary-subtotal"
                                          th:text="${#numbers.formatDecimal(subtotal, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currencySymbol}">
                                     </span>
                                </li>
                                <li id="summary-coupon-discount-row"
                                    th:if="${couponDiscount != null and couponDiscount.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                                    class="list-group-item d-flex justify-content-between px-0 text-success">
                                    <span class="summary-label">Sleva (<span
                                            th:text="${validatedCoupon?.code ?: cart?.appliedCouponCode}">Kód</span>)</span>
                                    <span class="summary-value" id="summary-coupon-discount"
                                          th:text="'-' + ${#numbers.formatDecimal(couponDiscount, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currencySymbol}"></span>
                                </li>
                                <li id="summary-subtotal-after-discount-row"
                                    th:if="${couponDiscount != null and couponDiscount.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                                    class="list-group-item d-flex justify-content-between px-0 pt-2 mt-1 border-top">
                                    <span class="summary-label">Mezisoučet po slevě (bez DPH)</span>
                                    <span class="summary-value" id="summary-total-without-tax-after-discount"
                                          th:text="${#numbers.formatDecimal(totalPriceWithoutTaxAfterDiscount, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currencySymbol}"></span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between px-0">
                                    <span class="summary-label">Doprava (bez DPH)</span>
                                    <span class="summary-value" id="summary-original-shipping-cost">
                                         <span th:if="${originalShippingCostNoTax != null}"
                                               th:text="${#numbers.formatDecimal(originalShippingCostNoTax, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currencySymbol}"></span>
                                         <span th:unless="${originalShippingCostNoTax != null}"
                                               class="text-warning recalculate-shipping-notice">
                                             <span th:text="${shippingError != null ? shippingError : '(Nutno spočítat)'}"></span>
                                         </span>
                                     </span>
                                </li>
                                <li id="summary-shipping-discount-row"
                                    class="list-group-item d-flex justify-content-between px-0 text-success"
                                    th:classappend="${(shippingDiscountAmount == null or shippingDiscountAmount.compareTo(T(java.math.BigDecimal).ZERO) <= 0) ? 'd-none' : ''}">
                                    <span class="summary-label">Sleva na dopravu</span>
                                    <span class="summary-value" id="summary-shipping-discount-value"
                                          th:text="${shippingDiscountAmount != null and shippingDiscountAmount.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? ('- ' + #numbers.formatDecimal(shippingDiscountAmount, 1, 'WHITESPACE', 2, 'COMMA') + ' ' + currencySymbol) : ''}"></span>
                                </li>

                                <li class="list-group-item px-0 pt-2 mt-1 border-top">
                                    <div class="d-flex justify-content-between">
                                        <span class="summary-label">Celkem DPH</span>
                                        <span class="summary-value" id="summary-total-vat"
                                              th:text="${#numbers.formatDecimal(totalVatWithShipping, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currencySymbol}"></span>
                                    </div>
                                    <div id="vat-breakdown-items" class="ps-2"
                                         th:if="${vatBreakdown != null and not vatBreakdown.isEmpty()}">
                                        <small class="text-muted vat-breakdown-item d-flex justify-content-between"
                                               th:each="entry : ${vatBreakdown}">
                                            <span th:text="'z toho DPH ' + ${#numbers.formatDecimal(entry.key.multiply(100), 1, 'DEFAULT', 0, 'POINT')} + '% (zboží)'"></span>
                                            <span class="summary-value"
                                                  th:text="${#numbers.formatDecimal(entry.value, 1, 'WHITESPACE', 2, 'COMMA')} + ' ' + ${currencySymbol}"></span>
                                        </small>
                                    </div>
                                    <div id="vat-breakdown-shipping" class="ps-2"
                                         th:style="${shippingTax != null and shippingTax.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? '' : 'display: none;'}">
                                        <small class="text-muted vat-breakdown-item d-flex justify-content-between">
                                            <span>z toho DPH <th:block th:if="${shippingTaxRate != null}"
                                                                       th:text="${#numbers.formatDecimal(shippingTaxRate.multiply(100), 1, 'DEFAULT', 0, 'POINT')} + '%'"/> (doprava)</span>
                                            <span class="summary-value" id="summary-shipping-tax"
                                                  th:text="${shippingTax != null ? #numbers.formatDecimal(shippingTax, 1, 'WHITESPACE', 2, 'COMMA') + ' ' + currencySymbol : '---'}"></span>
                                        </small>
                                    </div>
                                </li>

                                <li class="list-group-item d-flex justify-content-between px-0 pt-3 mt-2 border-top">
                                    <span class="summary-label">Mezisoučet celkem (s DPH)</span>
                                    <span class="summary-value" id="summary-original-total-price"
                                          th:text="${originalTotalPrice != null ? #numbers.formatDecimal(originalTotalPrice, 1, 'WHITESPACE', 2, 'COMMA') : '---'} + ' ' + ${currencySymbol}">
                                     </span>
                                </li>

                                <li id="summary-rounding-row"
                                    th:classappend="${roundingDifference == null or roundingDifference.abs().compareTo(T(java.math.BigDecimal).valueOf(0.001)) <= 0 ? 'd-none' : ''}"
                                    class="list-group-item d-flex justify-content-between px-0 text-muted">
                                    <span class="summary-label">Odstranění haléřů/centů</span>
                                    <span class="summary-value" id="summary-rounding-difference"
                                          th:text="${roundingDifference != null ? #numbers.formatDecimal(roundingDifference, 1, 'WHITESPACE', 2, 'COMMA') + ' ' + currencySymbol : ''}">
                                    </span>
                                </li>

                                <li class="list-group-item d-flex justify-content-between px-0 pt-3 mt-2 border-top summary-total">
                                    <span class="summary-label">Celkem k úhradě</span>
                                    <strong class="summary-value" id="summary-total-price">
                                          <span th:if="${totalPrice != null}"
                                                th:text="${#numbers.formatDecimal(totalPrice, 1, 'WHITESPACE', 0, 'COMMA')} + ' ' + ${currencySymbol}">
                                          </span>
                                        <span th:unless="${totalPrice != null}"
                                              class="text-warning fw-normal recalculate-shipping-notice">
                                              <span th:text="${shippingError != null ? shippingError : '(Nutno přepočítat dopravu)'}"></span>
                                          </span>
                                    </strong>
                                </li>
                            </ul>

                            <div class="form-check mt-4 mb-3">
                                <input type="checkbox" class="form-check-input" id="agreeTerms" th:field="*{agreeTerms}"
                                       required th:classappend="${#fields.hasErrors('agreeTerms')} ? 'is-invalid'">
                                <label class="form-check-label" for="agreeTerms">
                                    Souhlasím s <a href="/obchodni-podminky" target="_blank">obchodními podmínkami</a> a
                                    <a href="/gdpr" target="_blank">zpracováním osobních údajů</a> <span
                                        class="text-danger">*</span>
                                </label>
                                <div th:if="${#fields.hasErrors('agreeTerms')}" class="invalid-feedback d-block"><span
                                        th:errors="*{agreeTerms}">Musíte souhlasit s podmínkami</span></div>
                            </div>

                            <div id="recalculate-shipping-notice-area"
                                 class="alert alert-warning text-center small p-2 d-none" role="alert">
                                Došlo ke změně adresy, prosím <a href="#" id="recalculate-link" class="alert-link">přepočítejte
                                cenu dopravy</a>.
                            </div>

                            <button id="submit-order-button" class="w-100 btn btn-success btn-lg" type="submit"
                                    th:disabled="${(totalPrice == null) or (cart == null or not cart.hasItems())}">
                                Odeslat objednávku
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>
<th:block layout:fragment="javascript">
    <script th:src="@{/js/pokladna.js}"></script>
    <script id="checkoutDataForTracking" type="application/json" th:utext="${checkoutDataJson}"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[CHECKOUT] DOMContentLoaded.");

            function trackCheckoutBegin() {
                console.log("[CHECKOUT] Funkce trackCheckoutBegin spuštěna.");
                const checkoutDataElement = document.getElementById('checkoutDataForTracking');
                if (checkoutDataElement) {
                    try {
                        const checkoutEventData = JSON.parse(checkoutDataElement.textContent);

                        const ecommerceDataForService = checkoutEventData?.ecommerce;

                        if (ecommerceDataForService && ecommerceDataForService.items && ecommerceDataForService.items.length > 0) {
                            console.log("[CHECKOUT] Volám trackBeginCheckout přes executeTrackingWhenReady.");
                            executeTrackingWhenReady(
                                () => window.trackingService.trackBeginCheckout(ecommerceDataForService),
                                'trackBeginCheckout'
                            );
                        } else {
                            console.warn('[CHECKOUT] Chybí data ecommerce nebo položky pro trackBeginCheckout.');
                        }
                    } catch (e) {
                        console.error('[CHECKOUT] Chyba při parsování JSON pro checkout nebo volání executeTrackingWhenReady:', e);
                    }
                } else {
                    console.warn('[CHECKOUT] Element s JSON daty pro checkout nebyl nalezen.');
                }
            }

            trackCheckoutBegin();

        });
        /*]]>*/
    </script>
</th:block>
</body>
</html>