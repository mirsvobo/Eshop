function formatCurrency(a,b,c=2){if(a===null||typeof a==="undefined"||isNaN(a))return"---";const d=parseFloat(a.toFixed(c));return d.toLocaleString("cs-CZ",{minimumFractionDigits:c,maximumFractionDigits:c})+" "+b}function safeParseFloat(a){if(a===null||typeof a==="undefined")return null;const b=String(a).replace(",",".").replace(/[^\d.-]/g,""),c=parseFloat(b);return isNaN(c)?null:c}document.addEventListener("DOMContentLoaded",function(){const a=document.getElementById("checkout-form");if(!a){console.error("JS Error: Checkout form #checkout-form not found! Script cannot initialize.");return}const b=a.dataset;console.log("JS: Checkout script starting (v23 - Phone Prefix)...");const c=b.isUserLoggedIn==="true",d=b.csrfToken||null,e=b.csrfHeaderName||null,f=b.calculateShippingUrl||"/pokladna/calculate-shipping",g=b.currencySymbol||"Kč";let h=b.initialShippingValid==="true";const i=b.initialCartEmpty==="true",j=safeParseFloat(b.initialSubtotal||"0"),k=safeParseFloat(b.initialCouponDiscount||"0"),l=safeParseFloat(b.initialTotalItemVat||"0");console.log("JS: Initial values from data - isUserLoggedIn:",c,"shippingCalculatedSuccessfully:",h,"cartIsEmpty:",i);console.log("JS: Initial prices from data - Subtotal:",j,"CouponDiscount:",k,"ItemVAT:",l);console.log("JS: Config - csrfToken:",d?"***":null,"csrfHeader:",e,"shippingUrl:",f,"symbol:",g);const m=document.getElementById("phonePrefix"),n=document.getElementById("phoneNumberPart"),o=document.getElementById("phone"),p=document.getElementById("deliveryPhonePrefix"),q=document.getElementById("deliveryPhoneNumberPart"),r=document.getElementById("deliveryPhone");function s(){console.log("JS: updateSubmitButtonState called. Current shippingCalculatedSuccessfully:",h);const a=document.getElementById("submit-order-button"),b=document.getElementById("recalculate-shipping-notice-area"),c=i;if(!a||!b){console.error("JS Error in updateSubmitButtonState: elements #submit-order-button or #recalculate-shipping-notice-area not found!");return}const d=c||!h;a.disabled=d;console.log("JS: updateSubmitButtonState - Button disabled:",d);if(!c&&!h){const a=document.querySelector("#summary-total-price .recalculate-shipping-notice span"),d=a?a.textContent.replace(/[()]/g,""):"Pro odeslání objednávky je nutné nejprve spočítat dopravu.";b.textContent=d;b.classList.remove("d-none");console.log("JS: updateSubmitButtonState - Recalculate notice shown:",d)}else{b.classList.add("d-none");console.log("JS: updateSubmitButtonState - Recalculate notice hidden.")}}function t(a){console.log("JS: updateSummary called with AJAX data:",a);const b=document.getElementById("summary-original-total-price"),c=document.getElementById("summary-rounding-row"),d=document.getElementById("summary-rounding-difference"),e=document.getElementById("summary-total-price"),i=document.getElementById("shipping-cost-display"),m=document.getElementById("shipping-cost-value"),n=document.getElementById("shipping-cost-error"),o=document.getElementById("summary-original-shipping-cost"),p=document.getElementById("summary-shipping-tax"),q=document.getElementById("summary-shipping-discount-row"),r=document.getElementById("summary-shipping-discount-value"),v=document.getElementById("vat-breakdown-shipping"),w=document.getElementById("summary-total-vat"),x=document.getElementById("hiddenShippingCostNoTax"),y=document.getElementById("hiddenShippingTax"),z=document.getElementById("shipping-error-alert"),A=document.getElementById("shipping-error-text");if(i)i.classList.remove("error","calculating");if(n)n.textContent="";if(z)z.classList.add("d-none");h=!1;if(a&&a.errorMessage){console.error("JS Error: Shipping calculation API returned error:",a.errorMessage);const i=a.errorMessage||"Neznámá chyba výpočtu dopravy.";if(i&&n){i.classList.add("error");n.textContent=i}if(o)o.innerHTML=`<span class="text-danger recalculate-shipping-notice">${i}</span>`;if(b)b.textContent="---";if(c)c.classList.add("d-none");if(e)e.innerHTML=`<span class="text-warning fw-normal recalculate-shipping-notice">(Nutno přepočítat dopravu)</span>`;if(w)w.textContent=formatCurrency(l,g);if(x)x.value="";if(y)y.value="";if(v)v.style.display="none";if(q)q.style.display="none";if(A)A.textContent=i;if(z)z.classList.remove("d-none")}else if(a&&typeof a.shippingCostNoTax!=="undefined"&&a.shippingCostNoTax!==null&&a.totalPrice!==null){console.log("JS Info: Processing successful shipping calculation data.");h=!0;const i=safeParseFloat(a.shippingCostNoTax),l=safeParseFloat(a.shippingTax),C=safeParseFloat(a.totalPrice),D=Math.floor(C),E=safeParseFloat(a.originalShippingCostNoTax),F=safeParseFloat(a.shippingDiscountAmount),G=safeParseFloat(a.totalVatWithShipping),H=j-k,I=C,J=I-D;console.log(`JS Debug: calculatedOriginalTotal=${I}, roundedTotalToDisplay=${D}, calculatedRoundingDifference=${J}`);if(i&&m&&n){m.textContent=formatCurrency(i,a.currencySymbol)+" (bez DPH)";n.textContent=""}if(o){o.textContent=formatCurrency(E,a.currencySymbol);console.log("JS Debug: Updated #summary-original-shipping-cost to:",o.textContent)}else console.warn("JS Warn: #summary-original-shipping-cost not found.");if(q&&r){if(F!==null&&F>0);else;}else console.warn("JS Warn: Shipping discount elements not found.");if(v&&p){if(l!==null&&l>0){p.textContent=formatCurrency(l,a.currencySymbol);v.style.display="block";console.log("JS Debug: Updated and showing #summary-shipping-tax:",p.textContent)}else{v.style.display="none";console.log("JS Debug: Hiding shipping tax breakdown.")}}else console.warn("JS Warn: Shipping tax breakdown elements not found.");if(w){w.textContent=formatCurrency(G,a.currencySymbol);console.log("JS Debug: Updated #summary-total-vat to:",w.textContent)}else console.warn("JS Warn: #summary-total-vat not found.");if(b){b.textContent=formatCurrency(I,a.currencySymbol,2);console.log("JS Debug: Updated #summary-original-total-price to:",b.textContent)}else console.warn("JS Warn: #summary-original-total-price not found.");if(c&&d){if(J!==null&&Math.abs(J.toFixed(2))>0.00){d.textContent="- "+formatCurrency(J,a.currencySymbol,2);c.classList.remove("d-none");console.log("JS Debug: Showing rounding difference:",J)}else{d.textContent="";c.classList.add("d-none");console.log("JS Debug: Hiding rounding difference (Difference <= 0.00 after rounding):",J)}}else console.warn("JS Warn: Rounding display elements (#summary-rounding-row / #summary-rounding-difference) not found.");if(e){e.innerHTML="";const b=document.createElement("span");b.textContent=formatCurrency(D,a.currencySymbol,0);e.appendChild(b);e.classList.remove("text-warning","fw-normal","recalculate-shipping-notice");e.classList.add("fw-bold");console.log("JS Debug: Displaying final rounded total:",D)}else console.warn("JS Warn: #summary-total-price not found.");if(x){x.value=i!==null?i.toFixed(2):""}else console.warn("JS Warn: #hiddenShippingCostNoTax not found.");if(y){y.value=l!==null?l.toFixed(2):""}else console.warn("JS Warn: #hiddenShippingTax not found.");console.log("JS Info: Summary updated successfully from AJAX.")}else{console.error("JS Error: Invalid or incomplete numeric data received from shipping calculation API:",a);if(o)o.innerHTML=`<span class="text-danger recalculate-shipping-notice">(Chyba dat)</span>`;if(b)b.textContent="---";if(c)c.classList.add("d-none");if(v)v.style.display="none";if(w)w.textContent="---";if(e)e.innerHTML=`<span class="text-warning fw-normal recalculate-shipping-notice">(Chyba dat)</span>`}s()}function u(){console.log("JS: resetShippingDisplay called due to address change.");const a=document.getElementById("summary-total-price"),b=document.getElementById("shipping-cost-display"),c=document.getElementById("shipping-cost-value"),d=document.getElementById("shipping-cost-error"),e=document.getElementById("summary-original-shipping-cost"),f=document.getElementById("summary-shipping-tax"),i=document.getElementById("summary-shipping-discount-row"),j=document.getElementById("vat-breakdown-shipping"),k=document.getElementById("summary-total-vat"),m=document.getElementById("summary-original-total-price"),n=document.getElementById("summary-rounding-row"),o=document.getElementById("hiddenShippingCostNoTax"),p=document.getElementById("hiddenShippingTax");h=!1;if(b)b.classList.remove("error","calculating");if(c)c.textContent="";if(d)d.innerHTML=`<span class="text-warning recalculate-shipping-notice">(Nutno přepočítat)</span>`;if(e)e.innerHTML=`<span class="text-warning recalculate-shipping-notice">(Nutno přepočítat)</span>`;if(f)f.textContent="---";if(i)i.style.display="none";if(j)j.style.display="none";if(k)k.textContent=formatCurrency(l,g);if(m)m.textContent="---";if(n)n.classList.add("d-none");if(a)a.innerHTML=`<span class="text-warning fw-normal recalculate-shipping-notice">(Nutno přepočítat dopravu)</span>`;if(o)o.value="";if(p)p.value="";s()}function v(a,b){console.log("JS: toggleDeliveryFields called. Checkbox checked:",a?.checked);if(a&&b){b.classList.toggle("hidden",a.checked);u()}else console.warn("JS Warn: toggleDeliveryFields - checkbox or deliveryDiv not found.")}function w(a,b,c){if(a&&b&&c){const d=a.value,e=b.value.replace(/\s/g,""),f=d+e;c.value=f;console.log(`JS: Updated hidden input #${c.id} to: ${f}`);const g=c.nextElementSibling;if(g&&g.classList.contains("invalid-feedback"))g.textContent="";b.classList.remove("is-invalid")}else console.warn("JS Warn: Missing elements for updating combined phone.")}console.log("JS: Attaching DOMContentLoaded listeners...");const x=document.getElementById("calculate-shipping-btn"),y=document.querySelectorAll(".address-trigger"),z=document.getElementById("useInvoiceAddressAsDelivery"),A=document.querySelector(".delivery-address-fields");if(x){console.log("JS: Button #calculate-shipping-btn found. Attaching listener...");x.addEventListener("click",function(a){console.log("JS: Button #calculate-shipping-btn CLICKED!");a.preventDefault();console.log("JS: Default event prevented.");const b=this,c=b.querySelector(".spinner-border"),i=Array.from(b.childNodes).find(a=>a.nodeType===Node.TEXT_NODE&&a.textContent.trim().length>0),j=i?i.textContent.trim():"Spočítat dopravu dle adresy";console.log("JS: Disabling button and showing spinner.");b.disabled=!0;if(c)c.style.display="inline-block";if(i)i.textContent=" Počítám...";const k=document.getElementById("shipping-cost-display");if(k)k.classList.add("calculating");const l=document.getElementById("submit-order-button");if(l)l.disabled=!0;const m=document.getElementById("shipping-error-alert");if(m)m.classList.add("d-none");console.log("JS: Collecting address data...");const n={street:"",city:"",zipCode:"",country:""},o=z?z.checked:!0,p=o?"invoiceStreet":"deliveryStreet",q=o?"invoiceCity":"deliveryCity",r=o?"invoiceZipCode":"deliveryZipCode",v=o?"invoiceCountry":"deliveryCountry";n.street=document.getElementById(p)?.value||"";n.city=document.getElementById(q)?.value||"";n.zipCode=document.getElementById(r)?.value||"";n.country=document.getElementById(v)?.value||"";console.log(`JS: Collected address data (using invoice: ${o}):`,n);console.log("JS: Performing frontend address validation...");if(!n.street||!n.city||!n.zipCode||!n.country){const o=`Pro výpočet dopravy vyplňte kompletní ${o ? 'fakturační' : 'dodací'} adresu (Ulice, Město, PSČ, Země).`;console.warn("JS: Frontend address validation failed:",o);const p=document.getElementById("shipping-error-text");if(p)p.textContent=o;if(m)m.classList.remove("d-none");b.disabled=!1;if(c)c.style.display="none";if(i)i.textContent=j;if(k)k.classList.remove("calculating");s();console.log("JS: Exiting click handler due to validation error.");return}console.log("JS: Frontend validation passed.");const w={"Content-Type":"application/json",Accept:"application/json"};if(d&&e)w[e]=d;console.log("JS: Initiating fetch request to:",f," Headers:",w);fetch(f,{method:"POST",headers:w,body:JSON.stringify(n)}).then(a=>{console.log("JS Fetch: Received response status:",a.status);if(!a.ok)return a.json().then(a=>{throw a}).catch(()=>{throw new Error(`Chyba serveru (${a.status})`)});return a.json()}).then(a=>{console.log("JS Fetch: Received successful data:",a);t(a)}).catch(a=>{console.error("JS Fetch: Error during fetch:",a);t({errorMessage:a?.errorMessage||a?.message||"Chyba komunikace se serverem."})}).finally(()=>{console.log("JS Fetch: Finished. Resetting button state.");b.disabled=!1;if(c)c.style.display="none";if(i)i.textContent=j;if(k)k.classList.remove("calculating")});console.log("JS: Fetch request initiated.")});console.log("JS: Click listener attached successfully to #calculate-shipping-btn.")}else console.error("JS Error: Button #calculate-shipping-btn not found! Listener not attached.");if(y.length>0){console.log("JS: Attaching 'change' listeners to address trigger elements.");y.forEach(a=>{a.addEventListener("change",u)});console.log("JS: Change listeners attached to address triggers.")}else console.warn("JS Warning: No address trigger elements found.");if(z&&A){console.log("JS: Initializing delivery fields visibility based on checkbox state.");v(z,A);z.addEventListener("change",()=>v(z,A));console.log("JS: Change listener attached to delivery toggle checkbox.")}else console.warn("JS Warn: Checkbox/Div for delivery address toggle not found.");if(m&&n&&o){m.addEventListener("change",()=>w(m,n,o));n.addEventListener("input",()=>w(m,n,o));w(m,n,o);console.log("JS: Listeners and initial update for main phone attached.")}else console.warn("JS Warn: Elements for main phone listener not found.");if(p&&q&&r){p.addEventListener("change",()=>w(p,q,r));q.addEventListener("input",()=>w(p,q,r));w(p,q,r);console.log("JS: Listeners and initial update for delivery phone attached.")}else console.warn("JS Warn: Elements for delivery phone listener not found.");console.log("JS: Setting initial button state.");s();if(!h&&!i){console.log("JS Info: Initial shipping is invalid and cart not empty -> calling resetShippingDisplay().");u()}else console.log("JS Info: Initial shipping is valid or cart is empty. No initial reset needed.");console.log("JS: Checkout page initialization complete (v23 - Phone Prefix).")});
