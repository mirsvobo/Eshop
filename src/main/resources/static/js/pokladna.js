function formatCurrency(t,e,n=2){if(null===t||void 0===t||isNaN(t))return"---";const o=parseFloat(t.toFixed(n));return o.toLocaleString("cs-CZ",{minimumFractionDigits:n,maximumFractionDigits:n}).replace(/\s/g," ")+" "+e}function safeParseFloat(t){if(null===t||void 0===t)return null;const e=String(t).replace(",",".").replace(/[^\d.-]/g,""),n=parseFloat(e),o=isNaN(n)?null:n;return console.log(`safeParseFloat: Input='${t}', Cleaned='${e}', Parsed=${n}, Result=${o}`),o}
document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("checkout-form");if(!t)return void console.error("JS Error: Checkout form #checkout-form not found! Script cannot initialize.");const e=t.dataset;console.log("JS: Checkout script starting (v25 - Full with Fix)...");const n=e.isUserLoggedIn==="true",o=e.csrfToken||null,a=e.csrfHeaderName||null,s=e.calculateShippingUrl||"/pokladna/calculate-shipping",l=e.currencySymbol||"Kč";let r=e.initialShippingValid==="true";const i=e.initialCartEmpty==="true",c=safeParseFloat(e.initialSubtotal||"0"),d=safeParseFloat(e.initialCouponDiscount||"0"),u=safeParseFloat(e.initialTotalItemVat||"0");console.log("JS: Initial values - isUserLoggedIn:",n,"shippingOK:",r,"cartEmpty:",i),console.log("JS: Initial prices - Subtotal:",c,"CouponDiscount:",d,"ItemVAT:",u),console.log("JS: Config - csrfHeader:",a,"shippingUrl:",s,"symbol:",l);const p=document.getElementById("phonePrefix"),m=document.getElementById("phoneNumberPart"),h=document.getElementById("phone"),g=document.getElementById("deliveryPhonePrefix"),f=document.getElementById("deliveryPhoneNumberPart"),y=document.getElementById("deliveryPhone"),b=document.getElementById("calculate-shipping-btn"),v=document.querySelectorAll(".address-trigger"),k=document.getElementById("useInvoiceAddressAsDelivery"),E=document.querySelector(".delivery-address-fields"),S=document.getElementById("submit-order-button"),C=document.getElementById("recalculate-shipping-notice-area"),x=document.getElementById("shipping-cost-display"),w=document.getElementById("shipping-cost-value"),N=document.getElementById("shipping-cost-error"),L=document.getElementById("summary-original-shipping-cost"),D=document.getElementById("summary-shipping-tax"),I=document.getElementById("summary-shipping-discount-row"),A=document.getElementById("summary-shipping-discount-value"),B=document.getElementById("vat-breakdown-shipping"),P=document.getElementById("summary-total-vat"),_=document.getElementById("summary-original-total-price"),T=document.getElementById("summary-rounding-row"),O=document.getElementById("summary-rounding-difference"),U=document.getElementById("summary-total-price"),V=document.getElementById("hiddenShippingCostNoTax"),M=document.getElementById("hiddenShippingTax"),j=document.getElementById("shipping-error-alert"),F=document.getElementById("shipping-error-text");function q(){console.log("JS: updateSubmitButtonState. Shipping OK:",r);if(!S||!C)return void console.error("JS Error: updateSubmitButtonState - missing required elements (#submit-order-button or #recalculate-shipping-notice-area)!");const t=i,e=!t&&!r;S.disabled=e,console.log("JS: updateSubmitButtonState - Button disabled:",e);const n="Pro odeslání objednávky je nutné nejprve spočítat dopravu.";!t&&!r?(C.textContent=n,C.classList.remove("d-none"),console.log("JS: updateSubmitButtonState - Recalculate notice shown:",n)):(C.classList.add("d-none"),console.log("JS: updateSubmitButtonState - Recalculate notice hidden."))}
    function H(t){console.log("JS: updateSummary with AJAX data:",t),x&&x.classList.remove("error","calculating"),N&&(N.textContent=""),j&&j.classList.add("d-none"),r=!1;if(t&&t.errorMessage){console.error("JS Error: Shipping API error:",t.errorMessage);const e=t.errorMessage||"Neznámá chyba výpočtu dopravy.";x&&N&&(x.classList.add("error"),N.textContent=e),L&&(L.innerHTML=`<span class="text-danger recalculate-shipping-notice">${e}</span>`),_&&(_.textContent="---"),T&&T.classList.add("d-none"),U&&(U.innerHTML='<span class="text-warning fw-normal recalculate-shipping-notice">(Nutno přepočítat dopravu)</span>'),P&&(P.textContent=formatCurrency(u,l)),V&&(V.value=""),M&&(M.value=""),B&&(B.style.display="none"),I&&(I.style.display="none"),F&&(F.textContent=e),j&&j.classList.remove("d-none")}else if(t&&void 0!==t.shippingCostNoTax&&null!==t.shippingCostNoTax&&null!==t.totalPrice){console.log("JS Info: Processing successful shipping data."),r=!0;const e=safeParseFloat(t.shippingCostNoTax),n=safeParseFloat(t.shippingTax),o=safeParseFloat(t.totalPrice),a=Math.floor(o),s=safeParseFloat(t.originalShippingCostNoTax),i=safeParseFloat(t.shippingDiscountAmount),c=safeParseFloat(t.totalVatWithShipping),d=o,p=d-a;console.log(`JS Debug: Prices - costNoTax=${e}, tax=${n}, preciseTotal=${o}, roundedTotal=${a}, origCost=${s}, shipDiscount=${i}, totalVAT=${c}, origTotalCalc=${d}, roundingDiff=${p}`),x&&w&&N?(w.textContent=formatCurrency(e,l)+" (bez DPH)",N.textContent=""):console.warn("JS Warn: #shipping-cost-display elements not found."),L?L.textContent=formatCurrency(s,l):console.warn("JS Warn: #summary-original-shipping-cost not found."),I&&A?null!==i&&i>0?(A.textContent="- "+formatCurrency(i,l),I.style.display="flex"):I.style.display="none":console.warn("JS Warn: Shipping discount elements not found."),B&&D?null!==n&&n>0?(D.textContent=formatCurrency(n,l),B.style.display="block"):B.style.display="none":console.warn("JS Warn: Shipping tax breakdown elements not found."),P?P.textContent=formatCurrency(c,l):console.warn("JS Warn: #summary-total-vat not found."),_?_.textContent=formatCurrency(d,l,2):console.warn("JS Warn: #summary-original-total-price not found."),T&&O?null!==p&&Math.abs(p.toFixed(2))>.001?(O.textContent="- "+formatCurrency(p,l,2),T.classList.remove("d-none")):(O.textContent="",T.classList.add("d-none")):console.warn("JS Warn: Rounding display elements not found."),U?(U.innerHTML="",(()=>{const t=document.createElement("span");t.textContent=formatCurrency(a,l,0),U.appendChild(t)})(),U.classList.remove("text-warning","fw-normal","recalculate-shipping-notice"),U.classList.add("fw-bold")):console.warn("JS Warn: #summary-total-price not found."),V?V.value=null!==e?e.toFixed(2):"":console.warn("JS Warn: #hiddenShippingCostNoTax not found."),M?M.value=null!==n?n.toFixed(2):"":console.warn("JS Warn: #hiddenShippingTax not found."),console.log("JS Info: Summary updated successfully from AJAX.")}else console.error("JS Error: Invalid/incomplete data received from shipping API:",t),L&&(L.innerHTML='<span class="text-danger recalculate-shipping-notice">(Chyba dat)</span>'),_&&(_.textContent="---"),T&&T.classList.add("d-none"),B&&(B.style.display="none"),P&&(P.textContent="---"),U&&(U.innerHTML='<span class="text-warning fw-normal recalculate-shipping-notice">(Chyba dat)</span>');q()}
    function R(){console.log("JS: resetShippingDisplay called."),r=!1,x&&x.classList.remove("error","calculating"),w&&(w.textContent=""),N&&(N.innerHTML='<span class="text-warning recalculate-shipping-notice">(Nutno přepočítat)</span>'),L&&(L.innerHTML='<span class="text-warning recalculate-shipping-notice">(Nutno přepočítat)</span>'),D&&(D.textContent="---"),I&&(I.style.display="none"),B&&(B.style.display="none"),P&&(P.textContent=formatCurrency(u,l)),_&&(_.textContent="---"),T&&T.classList.add("d-none"),U&&(U.innerHTML='<span class="text-warning fw-normal recalculate-shipping-notice">(Nutno přepočítat dopravu)</span>'),V&&(V.value=""),M&&(M.value=""),q()}
    function W(t,e){console.log("JS: toggleDeliveryFields. Checked:",null==t?void 0:t.checked),t&&e?(e.classList.toggle("hidden",t.checked),R()):console.warn("JS Warn: toggleDeliveryFields - elements (#useInvoiceAddressAsDelivery or .delivery-address-fields) not found.")}function z(t,e,n,o=!1){if(!t||!e||!n)return void console.warn("JS Warn: Missing elements for updating combined phone.");const a=t.value,s=e.value,l=s.replace(/\D/g,""),r=e.nextElementSibling;if(l.length>0||!o)n.value=a+l,console.log(`JS: Updated hidden input #${n.id} to: ${a+l}`);else if(o&&n.value.startsWith(a))console.log(`JS: Initial call and number part is empty. Keeping hidden input #${n.id} value from DTO: ${n.value}`);else if(o){n.value=a,console.log(`JS: Initial call, number empty, prefix mismatch. Setting hidden input #${n.id} to prefix: ${a}`)}
        if(!o&& (e.classList.remove("is-invalid"),r&&r.classList.contains("invalid-feedback"))){r.textContent=""}if(!o&&s.trim().length>0){let t=9,o=9;l.length>0&&(l.length<t||l.length>o)&&(e.classList.add("is-invalid"),r&&r.classList.contains("invalid-feedback")&&(r.textContent=`Zadejte prosím platné ${t}místné číslo.`))}}b?(b.addEventListener("click",function(t){t.preventDefault(),console.log("JS: Calculate Shipping Button clicked.");const e=k?k.checked:!0,n={};e?(n.street=document.getElementById("invoiceStreet")?.value||"",n.city=document.getElementById("invoiceCity")?.value||"",n.zipCode=document.getElementById("invoiceZipCode")?.value||"",n.country=document.getElementById("invoiceCountry")?.value||""):(n.street=document.getElementById("deliveryStreet")?.value||"",n.city=document.getElementById("deliveryCity")?.value||"",n.zipCode=document.getElementById("deliveryZipCode")?.value||"",n.country=document.getElementById("deliveryCountry")?.value||"");if(!n.street||!n.city||!n.zipCode||!n.country)return console.warn("JS: Address data incomplete for shipping calculation."),H({errorMessage:"Prosím, vyplňte kompletní "+(e?"fakturační":"dodací")+" adresu."}),void q();console.log("JS: Sending shipping calculation request with address:",n);const l=b.querySelector(".spinner-border");b.disabled=!0,l&&l.classList.remove("d-none"),x&&x.classList.add("calculating"),N&&(N.textContent="(Počítám...)"),fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...(a&&o&&{[a]:o})},body:JSON.stringify(n)}).then(t=>{if(!t.ok)return t.json().then(e=>{throw new Error(e.errorMessage||`Chyba serveru: ${t.status}`)}).catch(()=>{throw new Error(`Chyba serveru: ${t.status}`)});return t.json()}).then(t=>{H(t)}).catch(t=>{console.error("JS Error: Shipping calculation failed:",t),H({errorMessage:t.message||"Chyba výpočtu dopravy."})}).finally(()=>{b.disabled=!1,l&&l.classList.add("d-none"),x&&x.classList.remove("calculating"),console.log("JS: Shipping calculation AJAX finished.")})}),console.log("JS: Event listener for shipping calculation button attached.")):console.warn("JS Warn: Calculate shipping button #calculate-shipping-btn not found!"),v.length>0?(v.forEach(t=>{t.addEventListener("input",R),t.addEventListener("change",R)}),console.log("JS: Event listeners attached to address trigger elements.")):console.warn("JS Warn: No address trigger elements found. Add class 'address-trigger' to address inputs."),k?(k.addEventListener("change",function(){W(this,E)}),W(k,E),console.log("JS: Event listener for delivery address toggle attached.")):console.warn("JS Warn: 'Use invoice address' checkbox #useInvoiceAddressAsDelivery not found."),p&&m&&h?(p.addEventListener("change",()=>z(p,m,h,!1)),m.addEventListener("input",()=>z(p,m,h,!1)),z(p,m,h,!0),console.log("JS: Listeners and initial setup for main phone attached.")):console.warn("JS Warn: Elements for main phone listener missing."),g&&f&&y?(g.addEventListener("change",()=>z(g,f,y,!1)),f.addEventListener("input",()=>z(g,f,y,!1)),z(g,f,y,!0),console.log("JS: Listeners and initial setup for delivery phone attached.")):console.warn("JS Warn: Elements for delivery phone listener missing.");const G=document.getElementById("form-validation-errors-summary"),K=null!==document.body.querySelector(".is-invalid");G&&K?(()=>{const t=document.querySelector("#checkout-form .is-invalid");t?(console.log("JS: Validation errors detected, scrolling to:",t),t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{try{"function"==typeof t.focus?(t.focus({preventScroll:!0}),console.log("JS: Focused first invalid field.")):console.log("JS: First invalid element not focusable.")}catch(t){console.error("Error focusing element:",t)}},300)):console.log("JS: General validation error, but no .is-invalid field found.")})():console.log("JS: No validation errors on load."),console.log("JS: Setting initial button state."),q(),!r&&!i?(console.log("JS Info: Initial shipping invalid & cart not empty -> resetting display."),R()):console.log("JS Info: Initial shipping OK or cart empty."),console.log("JS: Checkout page initialization complete (v25 - Full with Fix).")});
